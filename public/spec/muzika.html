<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Paule ‚Äì Muzika (Suno)</title>
<style>
:root{--bg:#05080f;--bg2:#0b111c;--ink:#e8eeff;--mut:#9fb0c7;--line:#1b2436;--pri:#7c8aff;--ok:#16c98a;--err:#ff5869;--br:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#0e1530 0%,#05080f 55%) fixed;color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto;overflow-y:auto}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.top{display:flex;align-items:center;gap:12px}
.x{margin-left:auto;cursor:pointer;font-size:22px;line-height:1;border:1px solid var(--line);border-radius:12px;padding:6px 10px;background:#0f1522}
.card{background:var(--bg2);border:1px solid var(--line);border-radius:var(--br);padding:16px;margin-top:16px}
label{display:block;margin:6px 0;color:#b8c4d9}
input,textarea,select{width:100%;padding:11px;border-radius:12px;background:#0a101a;color:var(--ink);border:1px solid #1b2436;outline:0}
.btn{display:inline-flex;gap:8px;align-items:center;padding:9px 13px;border-radius:12px;border:1px solid #2a3550;background:#141b2b;color:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#6b7bff,#9e76ff);border:0}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
.status{margin-top:8px;min-height:24px}
.tracks{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.track{background:#0b121f;border:1px solid #1f2942;border-radius:12px;overflow:hidden;min-height:360px;position:relative}
.track .cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#090e19}
.track .pad{padding:10px;border-top:1px solid #18223a}
.hint{color:#9fb0c7;font-size:12px}

/* Loader ‚Äì 3 ≈æiedai + natos */
.loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(8,13,24,.35);backdrop-filter:blur(2px)}
.rings{position:relative;width:120px;height:120px}
.rings .ring{position:absolute;inset:0;border-radius:50%;border:3px solid transparent}
.r1{border-top-color:#7c8aff;animation:spin 1.2s linear infinite}
.r2{inset:10px;border-right-color:#9e76ff;animation:spinR 1.6s linear infinite}
.r3{inset:20px;border-bottom-color:#6bd0ff;animation:spin 2.0s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes spinR{to{transform:rotate(-360deg)}}
.notes{position:absolute;bottom:18%;left:50%;transform:translateX(-50%);display:flex;gap:10px;pointer-events:none;opacity:.9}
.notes span{font-size:18px;animation:up 1.6s ease-in infinite}
.notes span:nth-child(2){animation-delay:.2s}.notes span:nth-child(3){animation-delay:.4s}
@keyframes up{0%{transform:translateY(0);opacity:.2}40%{opacity:1}100%{transform:translateY(-80px);opacity:0}}

#now{position:fixed;left:0;right:0;bottom:0;background:#0b111c;border-top:1px solid #1b2436}
#now .in{max-width:980px;margin:0 auto;padding:8px 12px;display:flex;gap:10px;align-items:center}
#now img{width:36px;height:36px;border-radius:8px;border:1px solid #273453;object-fit:cover}
.muted{color:#9fb0c7}
.badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:5px 8px;border-radius:20px;border:1px solid #273453;background:#0f1626}
.badge.ok{border-color:#1f6e55}
.badge.err{border-color:#7a3040}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="display:flex;gap:10px;align-items:center">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none"><path d="M5 17c0-5 3-10 7-12 4-2 7 1 7 6 0 5-3 10-7 12-4 2-7-1-7-6Z" fill="url(#g)"/><defs><linearGradient id="g" x1="0" x2="24" y1="0" y2="24"><stop stop-color="#6b7bff"/><stop offset=".7" stop-color="#9e76ff"/></linearGradient></defs></svg>
        <strong>Muzikos generatorius (Suno)</strong>
      </div>
      <div id="credits" class="badge" title="Likutis">Kreditai: ‚Äî</div>
      <button class="x" onclick="closeMe()">‚úï U≈ædaryti</button>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Pavadinimas</label>
          <input id="title" placeholder="pvz.: Meilƒó tavo sieloje">
          <label>≈Ωod≈æiai / apra≈°ymas (‚â§180)</label>
          <textarea id="lyrics" placeholder="Palik tu≈°ƒçiƒÖ ‚Äì AI sugeneruos"></textarea>
          <small class="hint">AI santraukƒÖ/≈æod≈æius (‚â§180) suformatuos ƒØ 2‚Äì3 eilutes.</small>
        </div>
        <div class="col">
          <label>≈Ωanras / nuotaika</label>
          <input id="meta" placeholder="pvz.: synthwave, dreamy">
          <div class="row">
            <div class="col">
              <label>Modelis</label>
              <select id="model"><option>V3_5</option><option>V4</option><option selected>V4_5</option></select>
            </div>
            <div class="col">
              <label>Vokalas</label>
              <select id="voice"><option value="female" selected>Moteris</option><option value="male">Vyras</option><option value="none">Instrumental</option></select>
            </div>
          </div>
          <div class="row" style="align-items:flex-end">
            <div class="col">
              <label>Kalba</label>
              <select id="lang"><option value="lt" selected>LT</option><option value="en">EN</option></select>
            </div>
            <div class="col" style="text-align:right">
              <button class="btn" id="ai">‚úçÔ∏è Sukurti ≈æod≈æius (AI)</button>
              <button class="btn primary" id="go">üé∂ Generuoti</button>
            </div>
          </div>
        </div>
      </div>

      <div id="status" class="status"></div>

      <div class="tracks">
        <div class="track" id="t1">
          <img class="cover" id="c1" alt="">
          <div class="loader" id="l1" hidden>
            <div class="rings"><div class="ring r1"></div><div class="ring r2"></div><div class="ring r3"></div></div>
            <div class="notes"><span>‚ô™</span><span>‚ô´</span><span>‚ô©</span></div>
          </div>
          <div class="pad">
            <h3 id="tt1" style="margin:6px 0 8px">Daina A</h3>
            <audio id="a1" controls style="width:100%"></audio>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="p1">‚ñ∂Ô∏è Groti</button>
              <button class="btn" id="d1">‚¨áÔ∏è Atsisi≈≥sti</button>
            </div>
          </div>
        </div>
        <div class="track" id="t2">
          <img class="cover" id="c2" alt="">
          <div class="loader" id="l2" hidden>
            <div class="rings"><div class="ring r1"></div><div class="ring r2"></div><div class="ring r3"></div></div>
            <div class="notes"><span>‚ô™</span><span>‚ô´</span><span>‚ô©</span></div>
          </div>
          <div class="pad">
            <h3 id="tt2" style="margin:6px 0 8px">Daina B</h3>
            <audio id="a2" controls style="width:100%"></audio>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="p2">‚ñ∂Ô∏è Groti</button>
              <button class="btn" id="d2">‚¨áÔ∏è Atsisi≈≥sti</button>
            </div>
          </div>
        </div>
      </div>

      <small class="hint">Patarimas: vir≈°eliai gali atsirasti dar prie≈° galutinƒô audio ‚Äì rodom juos vos tik gaunam.</small>
    </div>
  </div>

  <div id="now">
    <div class="in">
      <img id="nimg" src="" alt="">
      <div id="nttl" class="muted" style="flex:1">Nieko negroja</div>
      <audio id="na" preload="metadata" crossorigin="anonymous" style="width:420px"></audio>
    </div>
  </div>

<script>
const qs = s=>document.querySelector(s);
const oneLine = s => (s||'').toString().replace(/\s+/g,' ').trim();
const limit = (s,n)=>{s=oneLine(s); if(s.length<=n) return s; let cut=s.slice(0,n), last=cut.lastIndexOf(' '); return (last>50?cut.slice(0,last):cut).trim();}
function closeMe(){ if(history.length>1) history.back(); else location.href='/' }
async function jres(r){ try{return await r.json()}catch(e){ return { ok:false, error:`JSON_${r.status}` }} }
function setNow(url,title,cover){ if(!url) return; const a=qs('#na'); const img=qs('#nimg'); const ttl=qs('#nttl'); a.src=url; a.play().catch(()=>{}); img.src=cover||''; ttl.textContent=title||'Track'; }

function setLoader(idx, on){ qs('#l'+idx).hidden = !on; }
function paint(idx, data){
  const img=qs('#c'+idx), h=qs('#tt'+idx), a=qs('#a'+idx), p=qs('#p'+idx), d=qs('#d'+idx);
  if(data.image) img.src = data.image;
  if(data.title) h.textContent = data.title;
  if(data.audio_url){
    a.src = data.audio_url;
    d.onclick = ()=> window.open(data.audio_url, '_blank');
    p.onclick = ()=> setNow(data.audio_url, data.title, data.image);
  } else if (data.stream){
    a.src = data.stream;
    p.onclick = ()=> setNow(data.stream, data.title, data.image);
    d.onclick = ()=> window.open(data.stream, '_blank');
  }
}

async function fetchCredits(){
  try{
    const r = await fetch('/api/music/credits');
    const j = await jres(r);
    const el = qs('#credits');
    if(j.ok && j.credits!=null){ el.textContent = 'Kreditai: '+j.credits; el.classList.add('ok'); }
    else { el.textContent = 'Kreditai: ‚Äî'; }
  }catch(_){}
}

qs('#ai').addEventListener('click', async ()=>{
  try{
    const title=oneLine(qs('#title').value||''); const meta=oneLine(qs('#meta').value||'');
    const r = await fetch('/api/stream', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'Return ‚â§180 chars clean Lithuanian lyrics'},{role:'user',content:JSON.stringify({title,meta,text:title||meta})}]})});
    const j = await jres(r);
    qs('#lyrics').value = limit(j.output || title || 'nauja daina', 180);
  }catch(e){ console.error('lyrics error', e); }
});

qs('#go').addEventListener('click', async ()=>{
  try{
    const title=oneLine(qs('#title').value||'Daina');
    let text = oneLine(qs('#lyrics').value||'');
    const meta = oneLine(qs('#meta').value||'');
    const model= qs('#model').value; const voice=qs('#voice').value; const lang = qs('#lang').value;

    if(!text){
      const r = await fetch('/api/stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'Return ‚â§180 chars catchy song idea'},{role:'user',content:JSON.stringify({title,meta})}]})});
      const j=await jres(r); text = limit(j.output||'melodic chorus, dreamy vibe',180);
    }

    qs('#status').textContent='‚è≥ Siunƒçiama‚Ä¶';
    setLoader(1,true); setLoader(2,true);

    const resp = await fetch('/api/music/create',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({title, prompt:text, model, style:meta, instrumental:(voice==='none'), vocalGender:voice, language:lang })
    });
    const j = await jres(resp);

    if(!j.ok || !j.task_id){
      setLoader(1,false); setLoader(2,false);
      qs('#status').innerHTML='<span style="color:#ff5869">‚ùå Nepavyko: '+(j.error||'klaida')+'</span>';
      console.error('create fail', j);
      return;
    }

    // start cover generation in parallel (optional, if API supports)
    fetch('/api/music/cover-generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({taskId:j.task_id})}).catch(()=>{});

    let tries=0, got=0, seenCovers=false;
    async function poll(){
      tries++;
      const rr = await fetch('/api/music/status?task='+encodeURIComponent(j.task_id));
      const s  = await jres(rr);

      if (Array.isArray(s?.tracks) && s.tracks.length){
        // try assign early covers
        if (!seenCovers) {
          s.tracks.forEach((t, i) => { if (t.image) paint((i+1), { image:t.image, title:t.title }); });
          seenCovers = s.tracks.some(t=>t.image);
        }
      }

      if (s.status==='ready'){
        const tA = s.tracks?.[0] || null;
        const tB = s.tracks?.[1] || null;
        if (tA){ paint(1, tA); setLoader(1,false); got++; }
        if (tB){ paint(2, tB); setLoader(2,false); got++; }
        if (!tB && tA){ setLoader(2,false); }
        qs('#status').innerHTML='<span style="color:#16c98a">‚úÖ Paruo≈°ta</span>';
        return;
      }
      if (s.status==='failed'){
        setLoader(1,false); setLoader(2,false);
        qs('#status').innerHTML='<span style="color:#ff5869">‚ùå Nepavyko</span>';
        return;
      }
      qs('#status').textContent='‚è≥ '+(s.vendor_status||s.status||'laukiama')+'‚Ä¶';
      if(tries<180) setTimeout(poll, 3000); else qs('#status').textContent='‚è≥ Ilgiau nei ƒØprasta‚Ä¶';
    }
    poll();

    // also poll covers endpoint, to maybe show covers even earlier
    (async function pollCovers(){
      for(let k=0;k<60;k++){
        try{
          const rr = await fetch('/api/music/cover-status');
          const cj = await jres(rr);
          if(cj.ok && Array.isArray(cj.images) && cj.images.length){
            const img = cj.images[0];
            if(!qs('#c1').src) qs('#c1').src = img;
            if(!qs('#c2').src) qs('#c2').src = img;
            break;
          }
        }catch(_){}
        await new Promise(r=>setTimeout(r, 3000));
      }
    })();

  }catch(e){
    setLoader(1,false); setLoader(2,false);
    qs('#status').innerHTML='<span style="color:#ff5869">‚ùå Klaida nar≈°yklƒóje. ≈Ωr. Console.</span>';
    console.error('go error', e);
  }
});

fetchCredits();
</script>
  <script>
(function(){
  const $ = (s)=>document.querySelector(s);
  function setLoader(on){
    const l1 = document.getElementById('l1');
    const l2 = document.getElementById('l2');
    if (l1) l1.hidden = !on;
    if (l2) l2.hidden = !on;
  }
  async function jres(r){ try{return await r.json()}catch(_){ return {ok:false} } }

  // deleguotas paspaudimo gaudymas (veiks net jei mygtukas ƒØterpiamas vƒóliau)
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('#go');
    if (!btn) return;

    try{
      setLoader(true);
      const title = ($('#title')?.value||'Daina').trim();
      const meta  = ($('#meta')?.value||'').trim();
      const voice = $('#voice')?.value || 'female';
      const model = $('#model')?.value || 'V3_5';
      const lang  = $('#lang')?.value || 'lt';
      let text    = ($('#lyrics')?.value||'').trim();

      if (!text) {
        const r0 = await fetch('/api/stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'Return ‚â§180 chars catchy song idea'},{role:'user',content:JSON.stringify({title,meta})}]})});
        const j0 = await jres(r0);
        text = (j0.output||'dreamy chorus, melodic hook').slice(0,180);
      }

      const r = await fetch('/api/music/create',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title, prompt:text, model, style:meta, instrumental:(voice==='none'), vocalGender:voice, language:lang })
      });
      const j = await jres(r);
      if (!j.ok || !j.task_id) {
        // atsarginis GET kelias, jei ka≈ækur POST ‚Äûnepralenda‚Äú
        const q = new URLSearchParams({ title, prompt:text, model, style:meta, instrumental:String(voice==='none'), vocalGender:voice });
        const r2 = await fetch('/api/music/create?'+q.toString());
        const j2 = await jres(r2);
        if (!j2.ok || !j2.task_id){ setLoader(false); console.error('create failed', j, j2); return; }
        j.task_id = j2.task_id;
      }

      let tries=0;
      async function poll(){
        tries++;
        const rr = await fetch('/api/music/status?task='+encodeURIComponent(j.task_id));
        const s  = await jres(rr);
        if (s.status==='ready'){
          const a1 = document.getElementById('a1'), c1=document.getElementById('c1'), tt1=document.getElementById('tt1');
          const t = s.tracks?.[0]; if (t && a1){ a1.src=t.audio_url||t.stream||''; if (c1 && t.image) c1.src=t.image; if (tt1 && t.title) tt1.textContent=t.title; }
          const t2 = s.tracks?.[1]; const a2 = document.getElementById('a2'), c2=document.getElementById('c2'), tt2=document.getElementById('tt2');
          if (t2 && a2){ a2.src=t2.audio_url||t2.stream||''; if (c2 && t2.image) c2.src=t2.image; if (tt2 && t2.title) tt2.textContent=t2.title; }
          setLoader(false); return;
        }
        if (s.status==='failed'){ setLoader(false); return; }
        if (tries<180) setTimeout(poll, 3000); else setLoader(false);
      }
      poll();
    }catch(err){
      setLoader(false);
      console.error('music click error', err);
    }
  });
})();
</script>

</body>
</html>
