
<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Paule ‚Äì Muzika (Suno)</title>
<style>
:root{--bg:#05080f;--bg2:#0b111c;--ink:#e8eeff;--mut:#9fb0c7;--line:#1b2436;--pri:#7c8aff;--ok:#16c98a;--err:#ff5869;--br:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#0e1530 0%,#05080f 55%) fixed;color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto;overflow-y:auto}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.top{display:flex;align-items:center;gap:12px}
.x{margin-left:auto;cursor:pointer;font-size:22px;line-height:1;border:1px solid var(--line);border-radius:12px;padding:6px 10px;background:#0f1522}
.card{background:var(--bg2);border:1px solid var(--line);border-radius:var(--br);padding:16px;margin-top:16px}
label{display:block;margin:6px 0;color:#b8c4d9}
input,textarea,select{width:100%;padding:11px;border-radius:12px;background:#0a101a;color:var(--ink);border:1px solid #1b2436;outline:0}
.btn{display:inline-flex;gap:8px;align-items:center;padding:9px 13px;border-radius:12px;border:1px solid #2a3550;background:#141b2b;color:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#6b7bff,#9e76ff);border:0}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
.status{margin-top:8px}
.track{background:#0b121f;border:1px solid #1f2942;border-radius:12px;overflow:hidden;margin-top:12px}
.track .pad{padding:10px;border-top:1px solid #18223a}
#now{position:fixed;left:0;right:0;bottom:0;background:#0b111c;border-top:1px solid #1b2436}
#now .in{max-width:980px;margin:0 auto;padding:8px 12px;display:flex;gap:10px;align-items:center}
#now img{width:36px;height:36px;border-radius:8px;border:1px solid #273453;object-fit:cover}
.muted{color:#9fb0c7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="display:flex;gap:10px;align-items:center">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none"><path d="M5 17c0-5 3-10 7-12 4-2 7 1 7 6 0 5-3 10-7 12-4 2-7-1-7-6Z" fill="url(#g)"/><defs><linearGradient id="g" x1="0" x2="24" y1="0" y2="24"><stop stop-color="#6b7bff"/><stop offset=".7" stop-color="#9e76ff"/></linearGradient></defs></svg>
        <strong>Muzikos generatorius (Suno)</strong>
      </div>
      <button class="x" onclick="closeMe()">‚úï U≈ædaryti</button>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Pavadinimas</label>
          <input id="title" placeholder="pvz.: Meilƒó tavo sieloje">
          <label>≈Ωod≈æiai / apra≈°ymas (‚â§180)</label>
          <textarea id="lyrics" placeholder="Palik tu≈°ƒçiƒÖ ‚Äì AI sugeneruos"></textarea>
          <small class="muted">AI santraukƒÖ/≈æod≈æius (‚â§180) suformatuos ƒØ 2‚Äì3 eilutes.</small>
        </div>
        <div class="col">
          <label>≈Ωanras / nuotaika</label>
          <input id="meta" placeholder="pvz.: synthwave, dreamy">
          <div class="row">
            <div class="col">
              <label>Modelis</label>
              <select id="model"><option>V3_5</option><option selected>V4_5PLUS</option></select>
            </div>
            <div class="col">
              <label>Vokalas</label>
              <select id="voice"><option value="female" selected>Moteris</option><option value="male">Vyras</option><option value="none">Instrumental</option></select>
            </div>
          </div>
          <div class="row" style="align-items:flex-end">
            <div class="col">
              <label>Kalba</label>
              <select id="lang"><option value="lt" selected>LT</option><option value="en">EN</option></select>
            </div>
            <div class="col" style="text-align:right">
              <button class="btn" id="ai">‚úçÔ∏è Sukurti ≈æod≈æius (AI)</button>
              <button class="btn primary" id="go">üé∂ Generuoti</button>
            </div>
          </div>
        </div>
      </div>

      <div id="status" class="status"></div>

      <div id="card" class="track" style="display:none">
        <img id="cover" alt="" style="width:100%;aspect-ratio:1/1;object-fit:cover">
        <div class="pad">
          <h3 id="tt" style="margin:6px 0 8px">Daina</h3>
          <audio id="aud" controls style="width:100%"></audio>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="play">‚ñ∂Ô∏è Groti</button>
            <button class="btn" id="dl">‚¨áÔ∏è Atsisi≈≥sti</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="now">
    <div class="in">
      <img id="nimg" src="" alt="">
      <div id="nttl" class="muted" style="flex:1">Nieko negroja</div>
      <audio id="na" preload="metadata" crossorigin="anonymous" style="width:420px"></audio>
    </div>
  </div>

<script>
const qs = (s)=>document.querySelector(s);
const oneLine = s => (s||'').toString().replace(/\s+/g,' ').trim();
const limit = (s,n)=>{s=oneLine(s); if(s.length<=n) return s; let cut=s.slice(0,n), last=cut.lastIndexOf(' '); return (last>50?cut.slice(0,last):cut).trim();}

function closeMe(){ if(history.length>1) history.back(); else location.href='/' }

async function ensureJson(r){try{return await r.json()}catch(e){return {ok:false,error:'JSON',status:r.status}}}

function setNow(url,title,cover){
  if(!url) return;
  const a=qs('#na'); const img=qs('#nimg'); const ttl=qs('#nttl');
  fetch(url).then(r=>r.blob()).then(b=>{a.src=URL.createObjectURL(b);a.play().catch(()=>{})}).catch(_=>{a.src=url;a.play().catch(()=>{})});
  img.src=cover||''; ttl.textContent=title||'Track';
}

qs('#ai').onclick=async ()=>{
  const title=oneLine(qs('#title').value||''); const meta=oneLine(qs('#meta').value||'');
  const r = await fetch('/api/stream', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'augam-auto',messages:[{role:'system',content:'Return ‚â§180 chars clean Lithuanian lyrics'},{role:'user',content:JSON.stringify({title,meta,text:title||meta})}]})});
  const j = await ensureJson(r); qs('#lyrics').value = limit(j.output||title||'nauja daina', 180);
};

qs('#go').onclick = async ()=>{
  const title=oneLine(qs('#title').value||'Daina');
  let text = oneLine(qs('#lyrics').value||'');
  const meta = oneLine(qs('#meta').value||'');
  const model= qs('#model').value; const voice=qs('#voice').value;
  const lang = qs('#lang').value;

  if(!text){
    const r = await fetch('/api/stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'Return ‚â§180 chars catchy song idea'},{role:'user',content:JSON.stringify({title,meta})}]})});
    const j=await ensureJson(r); text = limit(j.output||'melodic chorus, dreamy vibe',180);
  }

  qs('#status').textContent='‚è≥ Siunƒçiama‚Ä¶';
  const resp = await fetch('/api/music/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title, prompt:text, model, genre:meta, instrumental:(voice==='none'), vocalGender:voice, language:lang, lyrics_language:lang})});
  const j = await ensureJson(resp);
  if(!j.ok && !j.task_id && !j.audio_url){ qs('#status').innerHTML='<span style="color:#ff5869">‚ùå Nepavyko</span>'; return; }

  if(j.audio_url){
    // tiesioginis variantas
    showTrack({title,image:j.image||'',audio_url:j.audio_url});
    qs('#status').innerHTML='<span style="color:#16c98a">‚úÖ Paruo≈°ta</span>';
    return;
  }

  // poll
  const task = j.task_id;
  let tries = 0;
  async function poll(){
    tries++;
    const rr = await fetch('/api/music/status?task='+encodeURIComponent(task));
    const s  = await ensureJson(rr);
    if(s.status==='ready' && (s.audio_url || (s.tracks||[]).some(t=>t.audio_url))){
      const t = s.audio_url ? {title, image:s.tracks?.[0]?.image || '', audio_url:s.audio_url}
                            : (s.tracks || [])[0];
      showTrack(t||{});
      qs('#status').innerHTML='<span style="color:#16c98a">‚úÖ Paruo≈°ta</span>';
      return;
    }
    if(s.status==='failed'){ qs('#status').innerHTML='<span style="color:#ff5869">‚ùå Nepavyko</span>'; return; }
    qs('#status').textContent='‚è≥ '+(s.status||'laukiama')+'‚Ä¶';
    if(tries<120) setTimeout(poll, 4000); else qs('#status').textContent='‚è≥ Ilgiau nei ƒØprasta‚Ä¶';
  }
  poll();
};

function showTrack(t){
  const card=qs('#card'); card.style.display='block';
  qs('#cover').src = t.image || 'https://placehold.co/512x512/jpg?text=Cover';
  qs('#tt').textContent = t.title || 'Daina';
  const a=qs('#aud');
  fetch(t.audio_url).then(r=>r.blob()).then(b=>{a.src=URL.createObjectURL(b)}).catch(_=>{a.src=t.audio_url});
  qs('#play').onclick = ()=> setNow(t.audio_url, t.title, t.image);
  qs('#dl').onclick   = ()=> window.open(t.audio_url, '_blank');
}
</script>
</body>
</html>
