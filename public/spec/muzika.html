<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paule ‚Ä¢ Muzikos generatorius</title>
<style>
:root{--bg:#05080f;--bg2:#0b111c;--ink:#e8eeff;--mut:#9fb0c7;--line:#1b2436;--pri:#7c8aff;--ok:#16c98a;--err:#ff5869;--br:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#0e1530 0%,#05080f 55%) fixed;color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto;overflow-y:auto}
.wrap{max-width:980px;margin:0 auto;padding:18px}
h1{margin:0 0 8px}
.card{background:var(--bg2);border:1px solid var(--line);border-radius:var(--br);padding:16px;margin-top:16px}
label{display:block;margin:6px 0;color:#b8c4d9}
input,textarea,select{width:100%;padding:11px;border-radius:12px;background:#0a101a;color:var(--ink);border:1px solid #1b2436;outline:0}
.btn{display:inline-flex;gap:8px;align-items:center;padding:9px 13px;border-radius:12px;border:1px solid #2a3550;background:#141b2b;color:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#6b7bff,#9e76ff);border:0}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
.status{margin-top:8px;min-height:22px}

/* two track layout */
.tracks{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
@media(min-width:780px){.tracks{grid-template-columns:1fr 1fr}}
.track{background:#0b121f;border:1px solid #1f2942;border-radius:12px;overflow:hidden}
.track img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0a101a}
.track .pad{padding:10px;border-top:1px solid #18223a}
.track h3{margin:6px 0 8px}

/* triple-ring loader + bouncing note */
.loader{display:none;align-items:center;gap:12px;margin-top:8px}
.loader.show{display:flex}
.rings{position:relative;width:44px;height:44px}
.r1,.r2,.r3{position:absolute;border-radius:50%;border:3px solid transparent;inset:0}
.r1{border-top-color:#7c8aff;border-left-color:#7c8aff;animation:spin 1.1s linear infinite}
.r2{inset:5px;border-bottom-color:#9e76ff;border-right-color:#9e76ff;animation:spinR 1.4s linear infinite}
.r3{inset:10px;border-top-color:#16c98a;border-left-color:#16c98a;animation:spin 1.7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes spinR{to{transform:rotate(-360deg)}}
.note{font-size:18px;opacity:.9;animation:bob 1s ease-in-out infinite}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}

/* now playing */
#now{position:fixed;left:0;right:0;bottom:0;background:#0b111c;border-top:1px solid #1b2436}
#now .in{max-width:980px;margin:0 auto;padding:8px 12px;display:flex;gap:10px;align-items:center}
#now img{width:36px;height:36px;border-radius:8px;border:1px solid #273453;object-fit:cover}
.muted{color:#9fb0c7}
.dim{opacity:.8}
.ok{color:var(--ok)}
.err{color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
  <h1>üé∂ Muzikos generatorius (Suno)</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Pavadinimas</label>
        <input id="title" placeholder="pvz.: Meilƒó tavo sieloje">
        <label>≈Ωod≈æiai / apra≈°ymas (‚â§180)</label>
        <textarea id="lyrics" placeholder="Palik tu≈°ƒçiƒÖ ‚Äì AI sugeneruos"></textarea>
        <small class="dim">Trumpa santrauka/≈æod≈æiai (‚â§180) bus suformatuoti ƒØ 2‚Äì3 eilutes.</small>
      </div>
      <div class="col">
        <label>≈Ωanras / nuotaika</label>
        <input id="meta" placeholder="pvz.: synthwave, dreamy">
        <div class="row">
          <div class="col">
            <label>Modelis</label>
            <select id="model"><option>V3_5</option><option selected>V4_5</option></select>
          </div>
          <div class="col">
            <label>Vokalas</label>
            <select id="voice"><option value="female" selected>Moteris</option><option value="male">Vyras</option><option value="none">Instrumental</option></select>
          </div>
        </div>
        <div class="row" style="align-items:flex-end">
          <div class="col">
            <label>Kalba</label>
            <select id="lang"><option value="lt" selected>LT</option><option value="en">EN</option></select>
          </div>
          <div class="col" style="text-align:right">
            <button class="btn" id="ai">‚úçÔ∏è Sukurti ≈æod≈æius (AI)</button>
            <button class="btn primary" id="go">üé∂ Generuoti</button>
          </div>
        </div>
      </div>
    </div>

    <div id="status" class="status"></div>

    <div class="loader" id="loader">
      <div class="rings"><div class="r1"></div><div class="r2"></div><div class="r3"></div></div>
      <div class="note">‚ô´</div>
      <div class="dim" id="phase">Jungiama‚Ä¶</div>
    </div>

    <div class="tracks" id="tracks" style="display:none">
      <div class="track" id="t1">
        <img id="c1" alt="">
        <div class="pad">
          <h3 id="tt1">Daina #1</h3>
          <audio id="a1" controls style="width:100%"></audio>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="p1">‚ñ∂Ô∏è Groti</button>
            <button class="btn" id="d1">‚¨áÔ∏è Atsisi≈≥sti</button>
          </div>
        </div>
      </div>
      <div class="track" id="t2">
        <img id="c2" alt="">
        <div class="pad">
          <h3 id="tt2">Daina #2</h3>
          <audio id="a2" controls style="width:100%"></audio>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="p2">‚ñ∂Ô∏è Groti</button>
            <button class="btn" id="d2">‚¨áÔ∏è Atsisi≈≥sti</button>
          </div>
        </div>
      </div>
    </div>

    <div class="status dim" id="hint"></div>
  </div>
</div>

<div id="now">
  <div class="in">
    <img id="nimg" src="" alt="">
    <div id="nttl" class="muted" style="flex:1">Nieko negroja</div>
    <audio id="na" preload="metadata" crossorigin="anonymous" style="width:420px"></audio>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const j = r=>r.json().catch(()=>({}));
  const BASE = location.origin; // veiks paule.ai ir vercel preview
  const setPhase = s=>{ const ph=$('#phase'); if(ph) ph.textContent=s; };
  const loader = on => { $('#loader')?.classList.toggle('show', !!on); };
  const status = (html)=> { const n=$('#status'); if(n){ n.innerHTML = html; } };
  const hint = (html)=> { const n=$('#hint'); if(n){ n.innerHTML = html; } };

  function setNow(url,title,cover){
    if(!url) return;
    const a=$('#na'), img=$('#nimg'), ttl=$('#nttl');
    fetch(url).then(r=>r.blob()).then(b=>{a.src=URL.createObjectURL(b);a.play().catch(()=>{})}).catch(_=>{a.src=url;a.play().catch(()=>{})});
    img.src=cover||''; ttl.textContent=title||'Track';
  }

  async function ensureLyrics(title, meta){
    const r = await fetch('/api/stream',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[
        {role:'system',content:'Return ‚â§180 chars catchy Lithuanian song idea (2‚Äì3 short lines)'},
        {role:'user', content: JSON.stringify({title,meta})}
      ]})
    });
    const jj = await j(r);
    const txt = String(jj.output||title||meta||'melodic chorus, dreamy vibe').trim();
    return txt.length>180 ? (txt.slice(0,180).trim()) : txt;
  }

  async function startCover(taskId){
    try{
      setPhase('Kuriamas vir≈°elis‚Ä¶');
      await fetch('/api/music/cover-generate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ taskId })
      });
    }catch(_){}
  }
  async function pollCover(taskId){
    try{
      const r = await fetch('/api/music/cover-status?task='+encodeURIComponent(taskId));
      const jj = await j(r);
      const imgs = (jj.images||[]);
      if (imgs[0]) $('#c1').src = imgs[0];
      if (imgs[1]) $('#c2').src = imgs[1];
      if (imgs.length) return true;
    }catch(_){}
    return false;
  }

  async function pollStatus(taskId){
    let tries=0; const MAX=200;
    const iv = setInterval(async ()=>{
      tries++;
      const r = await fetch('/api/music/status?task='+encodeURIComponent(taskId));
      const s = await j(r);
      if (s.ok===false && s.error){ status('<span class="err">‚ùå '+(s.error||'klaida')+'</span>'); loader(false); clearInterval(iv); return; }
      if (s.status==='ready'){
        setPhase('Paruo≈°ta');
        const tracks = Array.isArray(s.tracks)?s.tracks:[];
        $('#tracks').style.display='grid';
        // T1
        const t1 = tracks[0] || {};
        if (t1.image) $('#c1').src = t1.image;
        if (t1.title) $('#tt1').textContent = t1.title;
        if (t1.audio_url || t1.stream){
          const url = t1.audio_url || t1.stream;
          const a1 = $('#a1'); fetch(url).then(r=>r.blob()).then(b=>{a1.src=URL.createObjectURL(b)}).catch(_=>{a1.src=url});
          $('#p1').onclick = ()=> setNow(url, t1.title||'Daina', t1.image||'');
          $('#d1').onclick = ()=> window.open(url, '_blank');
        }
        // T2 (jei yra)
        const t2 = tracks[1] || {};
        if (t2.image) $('#c2').src = t2.image;
        if (t2.title) $('#tt2').textContent = t2.title;
        if (t2.audio_url || t2.stream){
          const url2 = t2.audio_url || t2.stream;
          const a2 = $('#a2'); fetch(url2).then(r=>r.blob()).then(b=>{a2.src=URL.createObjectURL(b)}).catch(_=>{a2.src=url2});
          $('#p2').onclick = ()=> setNow(url2, t2.title||'Daina', t2.image||'');
          $('#d2').onclick = ()=> window.open(url2, '_blank');
        }

        status('<span class="ok">‚úÖ Paruo≈°ta</span>');
        loader(false); clearInterval(iv);
        return;
      }
      if (s.status==='failed'){
        status('<span class="err">‚ùå Nepavyko</span>');
        loader(false); clearInterval(iv); return;
      }
      if (tries===1) setPhase('Generuojama‚Ä¶');
      if (tries%5===0) setPhase('Vis dar generuojama‚Ä¶');
      if (tries===4) { await pollCover(taskId); } // pabandome anksti gauti vir≈°elƒØ
      if (tries>MAX){ status('‚è≥ Ilgiau nei ƒØprasta‚Ä¶'); loader(false); clearInterval(iv); }
    }, 3000);
  }

  // AI lyrics
  document.addEventListener('click', async (e)=>{
    if (!e.target.closest('#ai')) return;
    const title=($('#title')?.value||'').trim();
    const meta = ($('#meta')?.value||'').trim();
    const txt = await ensureLyrics(title, meta);
    $('#lyrics').value = txt;
  });

  // Generate
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('#go'); if (!btn) return;
    try{
      $('#tracks').style.display='none';
      $('#c1').src=''; $('#c2').src='';
      $('#a1').src=''; $('#a2').src='';
      $('#tt1').textContent='Daina #1'; $('#tt2').textContent='Daina #2';

      const title=($('#title')?.value||'Daina').trim();
      let text  = ($('#lyrics')?.value||'').trim();
      const meta  = ($('#meta')?.value||'').trim();
      const model = $('#model')?.value || 'V3_5';
      const voice = $('#voice')?.value || 'female';
      const lang  = $('#lang')?.value || 'lt';

      loader(true); setPhase('Jungiama‚Ä¶'); status(''); hint('');

      if(!text) text = await ensureLyrics(title, meta);

      const payload = {
        title,
        prompt: text,
        model,
        style: meta,
        instrumental: (voice==='none'),
        vocalGender: voice,
        language: lang
      };

      const r = await fetch('/api/music/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const jj = await j(r);
      if (!jj.ok || !jj.task_id){
        // fallback GET, jei kokiam edge scenarijuj POST neperteka
        const q = new URLSearchParams(payload); 
        const r2 = await fetch('/api/music/create?'+q.toString());
        const j2 = await j(r2);
        if (!j2.ok || !j2.task_id){ loader(false); status('<span class="err">‚ùå Nepavyko paleisti (create)</span>'); return; }
        jj.task_id = j2.task_id;
      }

      status('‚è≥ Laukiama‚Ä¶'); setPhase('U≈æduotis sukurta');
      $('#tracks').style.display='grid';

      startCover(jj.task_id).catch(()=>{});
      pollStatus(jj.task_id);
    }catch(err){
      loader(false); status('<span class="err">‚ùå Klaida: '+(err?.message||String(err))+'</span>');
      console.error(err);
    }
  });
})();
</script>
</body>
</html>
