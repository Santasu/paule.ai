<!DOCTYPE html> 
<html lang="lt" data-theme="light" data-backend="vercel">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Paule – Premium AI Chat</title>

  <!-- Favicons -->
  <link rel="icon" href="/assets/icon/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/assets/icon/favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/icon/favicon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/assets/icon/apple-touch-icon.png">
  <meta name="theme-color" content="#111827"/>

  <!-- Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Host + Clerk + Stripe -->
  <link rel="preconnect" href="/" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://js.stripe.com" crossorigin>
  <link rel="preconnect" href="https://clerk.com" crossorigin>
  <link rel="preconnect" href="https://api.clerk.com" crossorigin>
  <link rel="preconnect" href="https://img.clerk.com" crossorigin>

  <script async src="https://js.stripe.com/v3/pricing-table.js"></script>

  <!-- Pagrindinis CSS -->
  <link rel="stylesheet" href="/assets/css/paule.css?v=1.1.6"/>

  <!-- Papildomi stiliai (modal juodas, sprendimų juosta) -->
  <style>
    /* Modal – juodas fonas + ryškus X */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;z-index:1000}
    .modal-overlay.show{display:block}
    .modal-window{max-width:min(960px,92vw);margin:6vh auto;background:#0f1115;color:#f3f4f6;border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.45);}
    .modal--sheet{max-width:min(740px,92vw)}
    .modal-close{position:fixed;right:18px;top:18px;z-index:1001;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:6px 10px;cursor:pointer}
    .modal-body,.modal-sheet-inner{padding:20px}

    /* Sprendimų juosta (Ginčas/Teisėjas/Kompromisas) */
    .decision-bar{display:none;gap:10px;align-items:stretch;justify-content:center;padding:10px 12px}
    .decision-chip{flex:1;display:flex;gap:10px;align-items:center;justify-content:center;border-radius:14px;padding:10px;border:2px solid transparent;cursor:pointer;font-weight:700;user-select:none}
    .decision-chip:active{transform:translateY(1px)}
    .decision-chip[data-mode="debate"]{border-color:#ef4444;background:rgba(239,68,68,.06)}
    .decision-chip[data-mode="judge"]{border-color:#3b82f6;background:rgba(59,130,246,.06)}
    .decision-chip[data-mode="compromise"]{border-color:#10b981;background:rgba(16,185,129,.06)}
    .decision-chip img{width:18px;height:18px;opacity:.9}
    .decision-bar.boom{animation:db .28s ease}
    @keyframes db{0%{transform:scale(.99)}100%{transform:scale(1)}}

    /* „Į naujausią“ */
    .jump-latest{position:fixed;right:16px;bottom:2cm;display:none;padding:10px 12px;border-radius:12px;border:1px solid var(--border,#e5e7eb);background:var(--bg-primary,#fff);z-index:9}
    .jump-latest.show{display:flex;gap:8px;align-items:center}

    /* „AI mąsto…“ */
    ._ai-wait{display:flex;gap:10px;align-items:center;justify-content:center;padding:14px 10px;opacity:.9}
    ._ai-wait .dots span{display:inline-block;width:6px;height:6px;border-radius:50%;background:#9ca3af;margin:0 3px;animation:_w 1s infinite}
    ._ai-wait .dots span:nth-child(2){animation-delay:.15s}. _ai-wait .dots span:nth-child(3){animation-delay:.3s}
    @keyframes _w{0%{transform:translateY(0)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}
  </style>

  <!-- App konfigūracija -->
  <script>
    (function () {
      var MODE=(document.documentElement.getAttribute('data-backend')||'').trim().toLowerCase()==='vercel'?'vercel':'wp';
      var restBase=MODE==='vercel'?'/api':'/wp-json/paule/v1';
      var routes={
        base:restBase,
        stream:restBase+'/stream',
        models:restBase+'/models',
        diagnostics:restBase+'/diagnostics',
        comicCreate:restBase+'/comic/create',
        fluxCreate:restBase+'/flux/create',
        musicCreate:restBase+'/music/create',
        musicStatus:restBase+'/music/status',
        runwayImage:restBase+'/runway/image',
        runwayStatus:restBase+'/runway/status',
        suggest:restBase+'/suggest'
      };
      var CFG={mode:MODE,restBase:routes.base,restStream:routes.stream,restStreamSSE:routes.stream,sseDefault:1,
        pluginBase:'/assets',iconsBase:'/assets/icon',featuresBase:'/assets/features',routes:routes,version:'paule-1.1.6'};
      window.PAULE_CONFIG=CFG; window.AUGAM_CONFIG=CFG;
      try{Object.defineProperty(window,'API_BASE',{configurable:true,get:function(){return CFG.restBase;},set:function(_){}});}catch(e){}
      window.__SET_API_BASE__=function(v){};
    })();
  </script>

  <!-- Bridge WP -> /api -->
  <script>
    (function(){
      'use strict';
      try{
        var restBase=(window.PAULE_CONFIG&&window.PAULE_CONFIG.restBase)||'/api';
        if(window.EventSource){
          var OrigES=window.EventSource;
          window.EventSource=function(url,opts){
            try{url=String(url).replace(/\/wp-json\/(?:augam|paule)\/v1(\/|$)/,'/api$1').replace(/\/(?:augam|paule)\/v1(\/|$)/,'/api$1');}catch(_){}
            return new OrigES(url,opts);
          };
          window.EventSource.prototype=OrigES.prototype;
        }
        if(window.fetch){
          var origFetch=window.fetch;
          window.fetch=function(input,init){
            try{
              var u=(typeof input==='string')?input:(input&&input.url);
              if(u){
                var nu=String(u).replace(/\/wp-json\/(?:augam|paule)\/v1(\/|$)/,'/api$1').replace(/\/(?:augam|paule)\/v1(\/|$)/,'/api$1');
                if(nu!==u) input=(typeof input==='string')?nu:new Request(nu,input);
              }
            }catch(_){}
            return origFetch(input,init);
          };
        }
        window.__FORCE_STREAM_ENDPOINT__=restBase.replace(/\/+$/,'')+'/stream';
      }catch(e){console.warn('[PAULE bridge] warning:',e);}
    })();
  </script>

  <!-- HOTFIX: SSE -> JSON kai mode=once -->
  <script>
    (function(){
      'use strict';
      if (!window.fetch) return;
      const prevFetch = window.fetch;

      async function toJsonFromSSE(resp, models){
        const reader  = resp.body?.getReader?.();
        if (!reader) return null;
        const dec = new TextDecoder();
        let buf = '', text = '';
        for(;;){
          const it = await reader.read();
          if (it.done) break;
          buf += dec.decode(it.value, {stream:true});
          let idx;
          while ((idx = buf.indexOf('\n\n')) >= 0){
            const frame = buf.slice(0, idx).trim(); buf = buf.slice(idx+2);
            if (!frame) continue;
            const dataLine = frame.split('\n').find(l => l.startsWith('data:'));
            if (!dataLine) continue;
            const payload = dataLine.replace(/^data:\s*/,'').trim();
            if (payload === '[DONE]') { buf=''; break; }
            try{
              const j = JSON.parse(payload);
              const piece = j?.choices?.[0]?.delta?.content ?? j?.text ?? '';
              if (typeof piece === 'string') text += piece;
            }catch(_){}
          }
        }
        const answers = (models && models.length ? models : ['auto']).map(m => ({ model:m, text }));
        return { ok:true, answers };
      }

      window.fetch = async function(input, init){
        const url  = typeof input==='string' ? input : (input && input.url) || '';
        const meth = (init && init.method) || (typeof input!=='string' && input && input.method) || 'GET';
        const isStreamOnce = /\/api\/stream(?:\?|$)/.test(url) && /mode=once/.test(url) && String(meth).toUpperCase()==='POST';
        if (!isStreamOnce) return prevFetch(input, init);

        let models = [];
        try {
          const raw = (init && init.body) ? String(init.body) : '';
          if (raw) {
            const b = JSON.parse(raw);
            if (typeof b.models === 'string') { models = b.models.split(',').map(s=>s.trim()).filter(Boolean); }
          }
        } catch(_){}

        const resp = await prevFetch(input, init);
        const ct   = (resp.headers.get('content-type')||'').toLowerCase();
        if (ct.includes('text/event-stream')) {
          const json = await toJsonFromSSE(resp, models);
          if (json) {
            return new Response(JSON.stringify(json), {
              status: 200,
              headers: { 'Content-Type':'application/json; charset=utf-8', 'Cache-Control':'no-store' }
            });
          }
        }
        return resp;
      };
    })();
  </script>

  <!-- Global alias -->
  <script>
    window.sendMessage = function(){
      if (window.PauleMain && typeof window.PauleMain.sendMessage === 'function'){
        return window.PauleMain.sendMessage();
      }
    };
  </script>

  <!-- Clerk -->
  <script>
    window.__CLERK_PUBLISHABLE_KEY__ = "pk_live_Y2xlcmsucGF1bGUuYWkk";
    window.__CLERK_FRONTEND_API__    = "clerk.paule.ai";
  </script>
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_live_Y2xlcmsucGF1bGUuYWkk"
    data-clerk-frontend-api="clerk.paule.ai"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>
  <script>
    window.addEventListener('load', async () => {
      try{
        const c = window.Clerk;
        if (c?.load) {
          await c.load({
            publishableKey: window.__CLERK_PUBLISHABLE_KEY__,
            frontendApi: window.__CLERK_FRONTEND_API__,
          });
        }
      }catch(err){
        console.error("Clerk boot error:", err);
      }
    });
  </script>

  <noscript>
    <style>.nojs{position:fixed;inset:auto 0 0 0;background:#111827;color:#fff;padding:12px 16px;text-align:center;font:14px/1.4 system-ui}</style>
    <div class="nojs">Norint naudotis prisijungimu reikia įjungti JavaScript.</div>
  </noscript>
</head>
<body>

  <!-- ======== MODAL ROOT ======== -->
  <div id="modal" class="modal-overlay" aria-hidden="true">
    <button class="modal-close" type="button" aria-label="Uždaryti (Esc)">✕</button>
    <div class="modal-window modal--sheet" role="dialog" aria-modal="true" hidden>
      <div class="modal-sheet-inner" id="modalSheet"></div>
    </div>
    <div class="modal-window modal--tool" role="dialog" aria-modal="true" hidden>
      <div class="modal-body" id="modalTool"></div>
    </div>
  </div>

  <!-- ===== TOPBAR ===== -->
  <header class="topbar" data-no-clip="true" id="topbar" role="banner">
    <a class="brand" href="/" aria-label="Paule">
      <img id="brandLogo" class="brand-icon" src="/assets/icon/paule-logo.webp" alt="Paule logotipas">
    </a>

    <nav class="models-in-topbar" aria-label="Modeliai" id="modelList">
      <button class="model-pill active" data-model="paule" aria-pressed="true" type="button">
        <img class="ui-icon" src="/assets/icon/paule-logo.webp" alt=""> Paule
      </button>
      <button class="model-pill" data-model="chatgpt" type="button"><img class="ui-icon" src="/assets/icon/chatgpt.svg" alt=""> ChatGPT</button>
      <button class="model-pill" data-model="claude" type="button"><img class="ui-icon" src="/assets/icon/claude-seeklogo.svg" alt=""> Claude</button>
      <button class="model-pill" data-model="gemini" type="button"><img class="ui-icon" src="/assets/icon/gemini.svg" alt=""> Gemini</button>
      <button class="model-pill" data-model="grok" type="button"><img class="ui-icon" src="/assets/icon/xAI.svg" alt=""> Grok</button>
      <button class="model-pill" data-model="deepseek" type="button"><img class="ui-icon" src="/assets/icon/deepseek.svg" alt=""> DeepSeek</button>
      <button class="model-pill" data-model="llama" type="button"><img class="ui-icon" src="/assets/icon/llama.svg" alt=""> Llama</button>
    </nav>

    <div class="top-actions" id="topActions" role="navigation" aria-label="Pagrindiniai veiksmai">
      <a class="btn ghost" data-nav="pricing" href="#pricing" role="button">
        <img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> Planai
      </a>
      <a class="btn ghost" data-nav="community" href="/spec/bendruomene.html" role="button">
        <img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> Bendruomenė
      </a>
      <button class="btn ghost" id="btnNewChat" type="button">
        <img class="ui-icon" src="/assets/icon/nav-new-chat.svg" alt=""> Naujas pokalbis
      </button>
      <button class="btn ghost" id="btnTheme" type="button" aria-label="Perjungti temą">
        <img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> Tema
      </button>

      <div id="clerk-auth" class="login-anchor">
        <button class="btn ghost" id="loginFallback" type="button"
          onclick="window.openAuth ? openAuth() : (window.Clerk&&window.Clerk.openSignIn?window.Clerk.openSignIn({afterSignInUrl:'/',afterSignUpUrl:'/' }):alert('Kraunama…'));">
          <img class="ui-icon google" src="/assets/icon/google.svg" alt=""> Prisijungti
        </button>
      </div>

      <button class="btn ghost mobile-toggle" id="btnMobile" aria-label="Meniu (mobilus)" type="button">
        <img class="ui-icon" src="/assets/icon/nav-menu.svg" alt=""> Meniu
      </button>
    </div>
  </header>

  <div id="drawerOverlay" class="drawer-overlay" aria-hidden="true"></div>

  <div class="layout" id="layoutRoot">
    <aside class="sidebar" id="sidebar" role="complementary" aria-label="Šoninė navigacija">
      <section class="side-section collapsible" id="specSection">
        <div class="side-title"><span>AI specialistai</span><span class="car">▾</span></div>
        <div class="specialist-grid" id="specialistGrid">
          <a class="chip" href="/spec/bendruomene.html"   data-modal="tool"><img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> Bendruomenė</a>
          <a class="chip" href="/spec/sefas.html"         data-modal="tool"><img class="ui-icon" src="/assets/icon/chef-knife.svg" alt=""> Šefas</a>
          <a class="chip" href="/spec/marketing.html"     data-modal="tool"><img class="ui-icon" src="/assets/icon/marketing-megaphone.svg" alt=""> Marketing</a>
          <a class="chip" href="/spec/pardavimai.html"    data-modal="tool"><img class="ui-icon" src="/assets/icon/sales-handshake.svg" alt=""> Pardavimai</a>
          <a class="chip" href="/spec/verslas.html"       data-modal="tool"><img class="ui-icon" src="/assets/icon/business-strategy.svg" alt=""> Verslas</a>
          <a class="chip" href="/spec/finansai.html"      data-modal="tool"><img class="ui-icon" src="/assets/icon/finance-investment.svg" alt=""> Finansai</a>
          <a class="chip" href="/spec/keliones.html"      data-modal="tool"><img class="ui-icon" src="/assets/icon/travel-map.svg" alt=""> Kelionės</a>
          <a class="chip" href="/spec/tikslai.html"       data-modal="tool"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Tikslų žemėlapis</a>
          <a class="chip" href="/spec/psihologas.html"    data-modal="tool"><img class="ui-icon" src="/assets/icon/psychology-brain.svg" alt=""> Psichologas</a>
          <a class="chip" href="/spec/sportas.html"       data-modal="tool"><img class="ui-icon" src="/assets/icon/run.svg" alt=""> Sportas</a>
          <a class="chip" href="/spec/programuotojas.html" data-modal="tool"><img class="ui-icon" src="/assets/icon/code.svg" alt=""> Programuotojas</a>
          <a class="chip" href="/spec/produktyvumas.html"  data-modal="tool"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Produktyvumas</a>
          <a class="chip" href="/spec/daktaras.html"       data-modal="tool"><img class="ui-icon" src="/assets/icon/medical.svg" alt=""> Daktaras</a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Aktyvumas</div>
        <div class="community-pings" id="communityPings" aria-live="polite">
          <div class="ping"><img class="ui-icon" src="/assets/icon/music.svg" alt=""> @Mantas įkėlė dainą „Vasaros vėjas“</div>
          <div class="ping"><img class="ui-icon" src="/assets/icon/photo.svg" alt=""> @Ieva pridėjo 3 nuotraukas</div>
          <div class="ping"><img class="ui-icon" src="/assets/icon/video-library.svg" alt=""> @Ruta publikavo „Reklama-15s“</div>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#dainos">Dainos</a></div>
        <div class="library-grid thumbs" id="songsFeed">
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>„Vasaros vėjas“</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>„Nakties šviesos“</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>„Miesto pulsas“</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#nuotraukos">Nuotraukos</a></div>
        <div class="library-grid thumbs" id="photosFeed">
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Produktas</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Kampanija</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Viršelis</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#video">Video</a></div>
        <div class="library-grid thumbs" id="videosFeed">
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Reklama 15s</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Pristatymas</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Užkulisiai</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Projektai</div>
        <div class="control-group" id="projectsList">
          <div class="project-item" data-project="new" role="button" tabindex="0">
            <img class="ui-icon" src="/assets/icon/plus.svg" alt=""> Naujas projektas
          </div>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Pokalbių istorija</div>
        <div class="control-group" id="historyList"></div>
      </section>
    </aside>

    <main class="main" role="main">
      <div class="chat-area" id="chatArea">
        <!-- HERO -->
        <section class="welcome" id="welcome" aria-label="Pradinis ekranas">
          <h1 class="hero-title">KAIP GALIU PADĖTI ŠIANDIEN?</h1>
          <p>Pasirink viršuje modelius ir parašyk užklausą. Visi modeliai atsakys paraleliai. 👇</p>

          <div class="welcome-grid">
            <a class="welcome-card" href="#" data-action="song">
              <img src="/assets/hero/music.webp" alt="">
              <b>Sukurti dainą</b><span>Pasveikink draugą unikalia gimtadienio daina.</span>
            </a>
            <a class="welcome-card" href="#" data-action="song-photo">
              <img src="/assets/hero/song-photo.webp" alt="">
              <b>Daina iš nuotraukos</b><span>Įkelk kadrą ir gauk originalią melodiją su žodžiais.</span>
            </a>
            <a class="welcome-card" href="#" data-action="photo">
              <img src="/assets/hero/photo.webp" alt="">
              <b>Sukurti nuotrauką</b><span>Produktai, scenos, peizažai, selfiai ir animacija.</span>
            </a>
            <a class="welcome-card" href="#" data-action="mindmap">
              <img src="/assets/hero/mindmap.webp" alt="">
              <b>Minčių žemėlapis</b><span>Susitelk į esmę ir didink produktyvumą.</span>
            </a>
            <a class="welcome-card" href="/spec/tikslai.html" data-modal="tool">
              <img src="/assets/hero/goals.webp" alt="">
              <b>Tikslų sistema (AI)</b><span>Vizija → užduotys → realūs rezultatai.</span>
            </a>
            <a class="welcome-card" href="#" data-action="video">
              <img src="/assets/hero/video.webp" alt="">
              <b>Sukurti video</b><span>Reels ir Stories iš teksto ar nuotraukų.</span>
            </a>
          </div>
        </section>

        <!-- Planų sekcija (rodoma modale) -->
        <section id="pricing" class="pricing-section" aria-label="Planai" hidden>
          <h2 class="section-title">Planai</h2>
          <p class="section-sub">Pasirink sau tinkamiausią planą. Galima atšaukti bet kada.</p>
          <stripe-pricing-table
            pricing-table-id="prctbl_1S5mCdGfWPiTH9M4MOXoL4f3"
            publishable-key="pk_test_51S5jh4GfWPiTH9M4gRYoHhV9LiZBjn7FPavf9nXPFIvbBLjQ89oyMRvKu0FRIhqx8boX4IHvtvRbQUdUWnvJwmaf00NszDYZC7">
          </stripe-pricing-table>
          <noscript>Norint matyti kainas, įjunkite JavaScript.</noscript>
        </section>
      </div>
    </main>
  </div>

  <!-- ===== BOTTOM (sprendimų juosta + įvestis) ===== -->
  <div class="bottom-section after-message" id="bottomSection" data-responsive="true">
    <div class="decision-bar" id="decisionBar" aria-live="polite">
      <div class="decision-chip" data-mode="debate" title="AI ginčas">
        <img class="ui-icon" src="/assets/icon/swords.svg" alt=""> AI Ginčas
      </div>
      <div class="decision-chip" data-mode="judge" title="AI teisėjas">
        <img class="ui-icon" src="/assets/icon/legal-contract.svg" alt=""> AI Teisėjas
      </div>
      <div class="decision-chip" data-mode="compromise" title="Kompromisas">
        <img class="ui-icon" src="/assets/icon/handshake.svg" alt=""> Kompromisas
      </div>
    </div>

    <div class="follow-suggest-bar" id="followSuggestBar" aria-live="polite"></div>

    <div class="input-bar" id="inputBar">
      <div class="input-container" id="inputContainer">
        <label for="messageInput" class="sr-only">Parašyk čia…</label>
        <textarea class="message-input" id="messageInput" rows="1" placeholder="" autocomplete="on" autocapitalize="sentences" autocorrect="on" spellcheck="true"></textarea>
        <button class="send-btn" id="sendBtn" aria-label="Siųsti" type="button">
          <img class="ui-icon" src="/assets/icon/arrow-top.svg" alt="">
        </button>
        <div class="input-suggest-deck" id="inputSuggestDeck" aria-live="polite"></div>
      </div>
    </div>

    <div class="tools-bar" id="toolsBar" role="toolbar" aria-label="Įrankiai">
      <div class="tool" data-tool="mindmap" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Mindmap</div>
      <div class="tool" data-tool="photo"   tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-photo.svg" alt=""> Foto</div>
      <div class="tool" data-tool="file"    tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-file.svg" alt=""> Failas</div>
      <div class="tool" data-tool="song"    tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-music.svg" alt=""> Sukurti dainą</div>
      <div class="tool" data-tool="video"   tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/video-plus.svg" alt=""> Sukurti video</div>
      <div class="tool" data-tool="goals"   tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Tikslų sistema</div>
    </div>
  </div>

  <!-- ===== Orchestrator JS + Spec router ===== -->
  <script>
  /* =======================================================================
     Paule – Premium Chat Orchestrator • v2.3.1+
     - URL tvarkyklė: /spec/xxx.html (be #spec=)
     - 3 sprendimai po atsakymų: AI Ginčas • AI Teisėjas • Kompromisas
     - Po „Teisėjas“ → vertimas EN → /api/flux/create komiksui
     - Spalvotas Markdown (be „####“ šiukšlių), kopijavimas, scroll-lock
     ======================================================================= */
  (function () {
    'use strict';

    // --- Konfigai ---
    const CFG = (window.PAULE_CONFIG||{});
    const API_BASE = (CFG.restBase || '/api').replace(/\/+$/,'');
    const SSE_URL  = (CFG.restStreamSSE || CFG.restStream || (API_BASE+'/stream')).replace(/\/+$/,'');
    const COMPLETE_URL = API_BASE + '/complete';
    const SUGGEST_URL  = CFG.routes?.suggest || (API_BASE + '/suggest');
    const FLUX_URL     = CFG.routes?.fluxCreate || (API_BASE + '/flux/create');
    const ICONS_BASE = (CFG.iconsBase || '/assets/icon');
    const DEBUG = !!CFG.debug;

    // Tunables
    const SOFT_TIMEOUT_MS = 900;
    const HARD_DEADLINE_MS = 25000;
    const TYPE_MIN_DELAY = 8, TYPE_MAX_DELAY = 16;
    const SENTENCE_PAUSE_MIN = 120, SENTENCE_PAUSE_MAX = 220;

    // --- Bendra būsena ---
    const state = {
      theme: getInitialTheme(),
      selectedModels: ['auto'],
      isStreaming:false,
      chatId:null,
      lastUserText:'',
      hasMessagesStarted:false,
      stickToBottom:true,

      panels:{}, startedOrder:[], firstStarted:null,
      pending:0, errors:[], hasAnyText:false, suggestShown:false,
      decisionBarShown:false,
      lastRound:{},            // backId -> text
      specialMode:null,        // 'debate'|'judge'|'compromise'|null
    };

    // --- DOM ---
    const el = {
      modelList: document.getElementById('modelList'),
      chatArea: document.getElementById('chatArea'),
      decisionBar: document.getElementById('decisionBar'),
      welcome: document.getElementById('welcome'),
      messageInput: document.getElementById('messageInput'),
      sendBtn: document.getElementById('sendBtn'),
      sidebar: document.getElementById('sidebar'),
      btnMobile: document.getElementById('btnMobile'),
      btnNewChat: document.getElementById('btnNewChat'),
      mobileOverlay: document.getElementById('mobileOverlay') || document.getElementById('drawerOverlay'),
      bottomSection: document.getElementById('bottomSection'),
      songsFeed: document.getElementById('songsFeed'),
      photosFeed: document.getElementById('photosFeed'),
      videosFeed: document.getElementById('videosFeed'),
      followSuggestBar: document.getElementById('followSuggestBar'),
      toolsBar: document.getElementById('toolsBar'),
      modal: document.getElementById('modal'),
      modalClose: document.querySelector('#modal .modal-close'),
      modalSheet: document.querySelector('#modal .modal--sheet'),
      modalTool: document.querySelector('#modal .modal--tool'),
      modalSheetBody: document.getElementById('modalSheet'),
      modalToolBody: document.getElementById('modalTool'),
    };

    // --- Bootstrap ---
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

    async function init(){
      try{
        injectTypingDotsStyle();
        applyTheme(); bindEvents(); setInitialModelSelection(); updateBottomDock(); attachChatScroll();
        if (el.chatArea) el.chatArea.querySelectorAll('.message,.thinking,._ai-wait')?.forEach(n=>n.remove());
        startFeedsAutoRefresh();
        handleInitialSpecRoute(); // <- svarbu: atidaro /spec/xxx.html kaip modalą

        debug('🚀 Paule Orchestrator ready.');
      }catch(e){ console.error('[PAULE]init]', e); toast('Inicializacijos klaida', e.message); }
    }

    // --- Tema ---
    function getInitialTheme(){
      try{ const s=localStorage.getItem('paule_theme'); if (s&&s!=='auto') return s; }catch(_){}
      const h=new Date().getHours(); return (h>=20||h<7)?'dark':'light';
    }
    function applyTheme(){ document.documentElement.setAttribute('data-theme', state.theme); }

    // --- URL /spec router be hash ---
    function openModal(type, htmlOrEl){
      el.modal.classList.add('show');
      el.modal.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
      el.modalSheet.hidden=true; el.modalTool.hidden=true;
      if(type==='sheet'){
        el.modalSheet.hidden=false; el.modalSheetBody.innerHTML='';
        if(typeof htmlOrEl==='string') el.modalSheetBody.innerHTML=htmlOrEl; else if(htmlOrEl) el.modalSheetBody.appendChild(htmlOrEl);
      }else{
        el.modalTool.hidden=false; el.modalToolBody.innerHTML='';
        if(typeof htmlOrEl==='string') el.modalToolBody.innerHTML=htmlOrEl; else if(htmlOrEl) el.modalToolBody.appendChild(htmlOrEl);
      }
    }
    function closeModal(){
      el.modal.classList.remove('show');
      el.modal.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
      el.modalSheetBody.innerHTML=''; el.modalToolBody.innerHTML='';
      // grąžinam URL į „/“
      if (location.pathname.startsWith('/spec/')) history.replaceState(null,'','/');
    }
    el.modalClose?.addEventListener('click', closeModal);
    el.modal?.addEventListener('click', (e)=>{ if(e.target===el.modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && el.modal.classList.contains('show')) closeModal(); });

    async function openSpecModalByHref(href){
      if (!href) return;
      try{
        const res = await fetch(href, {cache:'no-store'});
        const html = await res.text();
        openModal('tool', html);
        history.pushState({modal:'spec', href}, '', href);
      }catch(_){
        // jeigu nepavyksta – keliaujam tiesiogiai
        location.href = href;
      }
    }
    // Atidarome modalą, jei puslapis užkrautas /spec/xxx.html
    async function handleInitialSpecRoute(){
      const p = location.pathname || '';
      if (p.startsWith('/spec/') && p.endsWith('.html')){
        await openSpecModalByHref(p);
      }
    }
    // Deleguotas click: bet kuris <a data-modal="tool" href="/spec/xxx.html">
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-modal="tool"]');
      if (a){
        const href = a.getAttribute('href') || '';
        if (/^\/spec\/.+\.html$/i.test(href)){ e.preventDefault(); openSpecModalByHref(href); }
      }
    });
    // Topbar: Planai – atsidaro kaip sheet
    (function(){
      const link=document.querySelector('a[data-nav="pricing"][href="#pricing"]');
      const source=document.getElementById('pricing');
      link?.addEventListener('click', (e)=>{
        e.preventDefault();
        if(!source) return;
        const clone = source.cloneNode(true);
        clone.hidden=false;
        openModal('sheet', clone);
      });
    })();
    // Popstate: jei grįžtam iš /spec – uždarom modalą
    window.addEventListener('popstate', ()=>{
      if (!location.pathname.startsWith('/spec/')) closeModal();
    });

    // Įrankiai apačioje → spec puslapiai kaip modalai
    el.toolsBar?.addEventListener('click', (e)=>{
      const t = e.target.closest('.tool'); if (!t) return;
      const tool = (t.getAttribute('data-tool')||'').toLowerCase();
      const map = { photo:'/spec/foto.html', song:'/spec/muzika.html', video:'/spec/video.html', goals:'/spec/tikslai.html', mindmap:'/spec/produktyvumas.html' };
      const href = map[tool]; if (href){ openSpecModalByHref(href); }
    });

    // --- Įvykiai ---
    function bindEvents(){
      el.modelList?.addEventListener('click', onModelClick);
      el.sendBtn?.addEventListener('click', sendMessage);
      el.messageInput?.addEventListener('keydown', e=>{
        if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
      });
      el.messageInput?.addEventListener('input', autoGrow);
      el.btnMobile?.addEventListener('click', ()=> el.sidebar?.classList.toggle('open'));
      el.mobileOverlay?.addEventListener('click', ()=> el.sidebar?.classList.remove('open'));
      el.btnNewChat?.addEventListener('click', ()=>location.reload());
      window.addEventListener('resize', updateBottomDock);

      // Sprendimų juosta
      el.decisionBar?.addEventListener('click', e=>{
        const chip = e.target.closest('.decision-chip'); if (!chip) return;
        const mode = chip.getAttribute('data-mode');
        el.decisionBar.classList.add('boom'); setTimeout(()=>el.decisionBar.classList.remove('boom'), 280);
        if (mode==='debate') startDebate();
        else if (mode==='compromise') startCompromise();
        else if (mode==='judge') startJudge();
      });
    }

    // --- Modelių pasirinkimas ---
    function onModelClick(e){
      const pill = e.target.closest('.model-pill'); if (!pill) return;
      let id = (pill.getAttribute('data-model')||'').toLowerCase().trim();
      if (id==='paule' || id==='augam-auto') id='auto';

      if (id==='auto'){
        el.modelList.querySelectorAll('.model-pill').forEach(p=>p.classList.remove('active'));
        pill.classList.add('active');
        state.selectedModels=['auto']; return;
      }
      el.modelList.querySelector('.model-pill[data-model="auto"]')?.classList.remove('active');
      pill.classList.toggle('active');
      const act = [...el.modelList.querySelectorAll('.model-pill.active')]
        .map(p=> (p.getAttribute('data-model')||'').toLowerCase().trim())
        .map(s=> (s==='paule'||s==='augam-auto') ? 'auto' : s)
        .filter(Boolean).filter(x=>x!=='auto');
      state.selectedModels = act.length ? act : ['auto'];
    }
    function getActiveFront(){ return (state.selectedModels.length? state.selectedModels.slice() : ['auto']); }
    function setInitialModelSelection(){
      el.modelList?.querySelectorAll('.model-pill').forEach(p=>p.classList.remove('active'));
      el.modelList?.querySelector('.model-pill[data-model="paule"]')?.classList.add('active');
      state.selectedModels=['auto'];
    }

    // --- Siuntimas ---
    async function sendMessage(){
      const text = (el.messageInput?.value || '').trim(); if (!text) return;
      resetRound();
      state.lastUserText = text;
      if (!state.hasMessagesStarted){ state.hasMessagesStarted = true; updateBottomDock(); }
      hideWelcome();
      addUserBubble(text);
      el.messageInput.value=''; autoGrow();

      const fronts = getActiveFront();
      try{ await startOrchestrator(text, fronts); }
      catch(e){ toast('Klaida siunčiant žinutę', e?.message||String(e)); finalizeRound(); }
    }

    function resetRound(){
      state.isStreaming = true;
      state.chatId = 'chat_'+Date.now()+'_'+Math.random().toString(36).slice(2);
      state.panels = {}; state.startedOrder = []; state.firstStarted = null;
      state.pending = 0; state.errors = []; state.hasAnyText=false; state.suggestShown=false;
      state.lastRound = {}; state.specialMode=null;
      el.followSuggestBar && (el.followSuggestBar.innerHTML='');
      showGlobalWait();
    }

    function hideWelcome(){ if (!el.welcome) return; el.welcome.style.display='none'; }
    function autoGrow(){
      const i = el.messageInput; if (!i) return;
      i.style.height='auto';
      const max = Math.floor(window.innerHeight * 0.40);
      i.style.height = Math.min(i.scrollHeight, max)+'px';
    }

    // --- UI burbulai ---
    const MODEL_ICON = {
      chatgpt:`${ICONS_BASE}/chatgpt.svg`, claude:`${ICONS_BASE}/claude-seeklogo.svg`,
      gemini:`${ICONS_BASE}/gemini.svg`,  grok:`${ICONS_BASE}/xAI.svg`,
      deepseek:`${ICONS_BASE}/deepseek.svg`, llama:`${ICONS_BASE}/llama.svg`,
      auto:`${ICONS_BASE}/ai.svg`, paule:`${ICONS_BASE}/ai.svg`, judge:`${ICONS_BASE}/legal-contract.svg`
    };
    const nameOf = (id)=>({paule:'Paule',auto:'Paule',chatgpt:'ChatGPT',claude:'Claude',gemini:'Gemini',grok:'Grok',deepseek:'DeepSeek',llama:'Llama'})[id]||id;
    function iconOf(id){ return MODEL_ICON[id] || MODEL_ICON.auto; }

    function addUserBubble(text){
      if (!el.chatArea) return;
      const n = document.createElement('div'); n.className='message user';
      n.innerHTML = `<div class="avatar"><img class="ui-icon" src="${ICONS_BASE}/user.svg" alt=""></div>
        <div class="bubble user"><div class="bubble-card">
          <div class="msg-content">${escapeHtml(text)}</div>
          <div class="msg-meta"><span>Jūs</span><span>${timeNow()}</span></div>
        </div></div>`;
      appendFade(n); scrollToBottomIfNeeded();
    }

    function ensurePanel(frontId){
      if (state.panels[frontId]) return state.panels[frontId];
      const n = document.createElement('div'); n.className='message';
      n.innerHTML = `<div class="avatar"><img class="ui-icon" src="${iconOf(frontId)}" alt=""></div>
        <div class="bubble" data-model="${frontId}">
          <div class="bubble-card">
            <button class="copy-btn" title="Kopijuoti"
             onclick="(function(b){const t=b.closest('.bubble-card')?.querySelector('.msg-content')?.innerText||'';navigator.clipboard.writeText(t).catch(()=>{});b.classList.add('ok');setTimeout(()=>b.classList.remove('ok'),900)})(this)"
             style="position:absolute;right:8px;top:8px;font-size:12px;border:1px solid var(--border);background:var(--bg-primary);padding:4px 6px;border-radius:6px;cursor:pointer;opacity:.8">⧉</button>
            <div class="msg-content"><span class="typing-dots"><i></i><i></i><i></i></span></div>
            <div class="msg-meta"><span>${escapeHtml(nameOf(frontId))}</span><span>${timeNow()}</span></div>
          </div>
        </div>`;
      appendFade(n);
      const contentEl = n.querySelector('.msg-content');
      const panel = { el: contentEl, content:'', done:false };
      state.panels[frontId]=panel;
      state.startedOrder.push(frontId);
      return panel;
    }
    function preparePanels(frontList){ (frontList||[]).forEach(f=> ensurePanel(f)); }

    // --- Orchestrator ---
    const FRONT_TO_BACK={
      paule:'together/openai/gpt-oss-20b',
      chatgpt:'gpt-5-mini',
      claude:'claude-3-5-sonnet-20241022',
      gemini:'gemini-2.5-flash',
      grok:'grok-2-latest',
      deepseek:'deepseek-chat',
      llama:'openrouter/meta-llama/llama-3.1-70b-instruct'
    };
    function splitTransports(fronts){ return { stream:fronts||[], json:[] }; }
    function getBackId(front){ return FRONT_TO_BACK[front]||front; }

    async function startOrchestrator(message, frontList){
      const parts   = splitTransports(frontList||[]);
      const streamF = parts.stream || [];
      const jsonF   = parts.json   || [];

      preparePanels([ ...streamF, ...jsonF ]);
      state.pending = (streamF.length) + (jsonF.length);

      streamF.forEach(front=>{
        const back = getBackId(front);
        runSSE({ front, back, message, chatId: state.chatId })
          .catch(err=> debug('runSSE error', front, err))
          .finally(()=>decPending());
      });

      if (jsonF.length){
        setTimeout(()=>{
          runJSONOnce({ fronts: jsonF, message, chatId: state.chatId })
            .catch(err=> debug('runJSONOnce error', err));
        }, SOFT_TIMEOUT_MS);
      }

      setTimeout(()=>{ finishIfHanging(); }, HARD_DEADLINE_MS);
    }

    function finishIfHanging(){
      if (!state.isStreaming) return;
      state.isStreaming=false;
      hideGlobalWait();
      finalizeRound();
    }

    function runSSE({ front, back, message, chatId }){
      return new Promise((resolve) => {
        const url = buildStreamUrl({ model: back, models: back, message, max_tokens:4096, chat_id:chatId, _t:Date.now() });
        const es = new EventSource(url);
        let gotAny=false, closed=false;

        const finalize = ()=>{
          if (closed) return; closed=true;
          try{ es.close(); }catch(_){}
          resolve();
        };

        es.addEventListener('open', ()=> debug('SSE open', front));
        es.addEventListener('start', e=>{
          try{ const d = JSON.parse(e.data||'{}'); if (d?.chat_id) state.chatId=d.chat_id; }catch(_){}
        });

        const handleDelta = (payload)=>{
          if (payload == null) return;
          if (String(payload).trim() === '[DONE]'){
            const panel = state.panels[front]; if (panel) panel.done = true;
            state.lastRound[ getBackId(front) ] = (panel?.content||'');
            finalize(); return;
          }

          const piece = safeDelta(payload);
          if (!piece) return;

          if (!gotAny){
            gotAny=true; state.hasAnyText=true; hideGlobalWait();
            if (!state.firstStarted) state.firstStarted = front;
          }
          const panel = ensurePanel(front);
          panel.content += piece;
          panel.el.innerHTML = parseMarkdown(panel.content);
          scrollToBottomIfNeeded();
        };

        es.addEventListener('delta', e=> handleDelta(e.data||''));
        es.addEventListener('message', e=> handleDelta(e.data||''));
        es.onmessage = (e)=> handleDelta(e.data||'');

        es.addEventListener('error', e=>{
          const msg = parseErr(e) || 'Modelio paslauga laikinai nepasiekiama.';
          state.errors.push({ front, name: nameOf(front), msg }); finalize();
        });
        es.addEventListener('done', _=>{
          const panel = state.panels[front];
          if (panel) panel.done = true;
          state.lastRound[ getBackId(front) ] = (panel?.content||''); finalize();
        });
        es.onerror = function(){ if (!gotAny) state.errors.push({ front, name: nameOf(front), msg:'Ryšio klaida (SSE).' }); finalize(); };
      });
    }

    async function runJSONOnce(){ /* nenaudojam šitam variante */ }

    // --- Pending / finalizacija ---
    function decPending(){
      state.pending = Math.max(0, state.pending - 1);
      if (state.pending === 0){
        state.isStreaming=false;
        hideGlobalWait();
        finalizeRound();
      }
    }

    async function finalizeRound(){
      // Klaidos
      if (state.errors.length){
        const wrap = document.createElement('div'); wrap.className='errors-wrap';
        state.errors.forEach(er=>{
          const n = document.createElement('div');
          n.className='message error';
          n.innerHTML = `<div class="avatar"><img class="ui-icon" src="${iconOf(er.front)}" alt=""></div>
            <div class="bubble"><div class="bubble-card error-card">
              <div class="msg-content"><strong>${escapeHtml(er.name)}</strong> – atsakymo nepavyko gauti.<br><span class="dim">${escapeHtml(er.msg||'Klaida')}</span></div>
              <div class="msg-meta"><span>${escapeHtml(er.name)}</span><span>${timeNow()}</span></div>
            </div></div>`;
          wrap.appendChild(n);
        });
        appendFade(wrap);
        scrollToBottomIfNeeded();
      }

      // Follow-ups
      if (!state.suggestShown){
        state.suggestShown = true;
        showFollowUps().catch(()=>{});
      }

      // Sprendimų juosta
      maybeShowDecisionBar();

      // Po specialių režimų – papildomas veiksmas
      if (state.specialMode === 'judge'){
        try{
          const judgeText = (state.panels.llama?.content || firstPanelText() || '').trim();
          if (judgeText){
            await generateComicFromJudge(judgeText);
          }
        }catch(_){}
        finally{ state.specialMode=null; }
      }
    }

    async function showFollowUps(){
      try{
        const bestFront = state.firstStarted || Object.keys(state.panels)[0] || 'auto';
        const bestText = (state.panels[bestFront]?.content || '').slice(0, 4000);
        const payload = { message: state.lastUserText || '', answer: stripMd(bestText), count: 6 };
        const res = await postJSON(SUGGEST_URL, payload);
        const list = Array.isArray(res?.suggestions) ? res.suggestions : [];
        renderFollowBar(uniqueNonEmpty(list).slice(0,6));
      }catch(_){
        renderFollowBar(['Paaiškink detaliau','Duok pavyzdį','Sukurk veiksmų planą','Kokie pavojai?','Kokie KPI?','Alternatyvus sprendimas']);
      }
    }
    function renderFollowBar(items){
      if (!el.followSuggestBar) return;
      el.followSuggestBar.innerHTML='';
      if (!items || !items.length){ el.followSuggestBar.classList.remove('show'); return; }
      items.forEach(s=>{
        const b=document.createElement('div');
        b.className='suggest-chip'; b.textContent=s; b.title=s; b.tabIndex=0;
        b.onclick=()=>{ el.messageInput.value=s; el.messageInput.focus(); };
        el.followSuggestBar.appendChild(b);
      });
      el.followSuggestBar.classList.add('show');
    }

    function maybeShowDecisionBar(){
      if (!el.decisionBar) return;
      const hasAny = Object.keys(state.panels||{}).length>0;
      el.decisionBar.style.display = hasAny ? 'flex' : 'none';
      state.decisionBarShown = hasAny;
    }

    // --- Feeds demo ---
    function startFeedsAutoRefresh(){ refreshFeeds(); setInterval(refreshFeeds, 6000); }
    function refreshFeeds(){
      fetch(API_BASE + '/library/recent?limit=3').then(r=>r.json()).then(data=>{
        try{ fillFeed(el.songsFeed, data.songs, '/assets/hero/music.webp'); }catch(_){}
        try{ fillFeed(el.photosFeed, data.photos, '/assets/hero/photo.webp'); }catch(_){}
        try{ fillFeed(el.videosFeed, data.videos, '/assets/hero/video.webp'); }catch(_){}
      }).catch(_=>{});
    }
    function fillFeed(root, items, placeholder){
      if (!root || !Array.isArray(items)) return;
      root.innerHTML = items.slice(0,3).map(it=>{
        const img = it.cover || it.thumb || it.url || placeholder;
        const title = it.title || 'Failas';
        const href = it.link || '#';
        return `<a class="lib-card thumb" href="${href}"><img src="${img}" alt=""><span>${escapeHtml(title)}</span></a>`;
      }).join('');
    }

    // --- Global wait ---
    function showGlobalWait(){
      if (document.querySelector('._ai-wait')) return;
      const w = document.createElement('div');
      w.className='_ai-wait';
      w.setAttribute('aria-live','polite');
      w.innerHTML = `<div class="_ai-wait-inner"><div class="dots"><span></span><span></span><span></span></div><div>AI mąsto, palaukite akimirką…</div></div>`;
      el.chatArea?.appendChild(w);
      scrollToBottomIfNeeded();
    }
    function hideGlobalWait(){ const w=document.querySelector('._ai-wait'); if (w){ w.remove(); } }

    // --- Scroll-lock / jump-to-latest ---
    let jumpBtn;
    function attachChatScroll(){
      if (!el.chatArea) return;
      if (!jumpBtn){
        jumpBtn = document.createElement('button');
        jumpBtn.className='jump-latest';
        jumpBtn.innerHTML = `<img class="ui-icon" src="${ICONS_BASE}/arrow-down.svg" alt=""> Į naujausią`;
        jumpBtn.addEventListener('click', ()=>{ el.chatArea.scrollTo({top:el.chatArea.scrollHeight, behavior:'smooth'}); jumpBtn.classList.remove('show'); state.stickToBottom=true; });
        document.body.appendChild(jumpBtn);
      }
      const onScroll = ()=>{
        const nearBottom = (el.chatArea.scrollTop + el.chatArea.clientHeight >= el.chatArea.scrollHeight - 80);
        state.stickToBottom = !!nearBottom;
        jumpBtn?.classList.toggle('show', !nearBottom);
      };
      el.chatArea.addEventListener('scroll', onScroll, { passive:true });
      onScroll();
    }
    function scrollToBottomIfNeeded(){
      if (!el.chatArea) return;
      if (state.stickToBottom){
        el.chatArea.scrollTo({ top: el.chatArea.scrollHeight });
        jumpBtn?.classList.remove('show');
      }else{
        jumpBtn?.classList.add('show');
      }
    }
    function updateBottomDock(){
      if (!el.bottomSection || !el.chatArea) return;
      const h = el.bottomSection.getBoundingClientRect().height || 0;
      el.chatArea.style.paddingBottom = Math.max(16, Math.ceil(h + 8))+'px';
    }

    // --- Transportai / utils ---
    function buildStreamUrl(qs){
      const base = SSE_URL.replace(/\/stream-sse$/,'/stream');
      const u = base + (base.includes('?')?'&':'?') + new URLSearchParams(qs).toString();
      return u;
    }
    async function postJSON(url, body){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function randomBetween(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
    function splitWordsPreserve(text){ return String(text||'').split(/(\s+)/); }
    async function typeInto(panel, text){
      const parts = splitWordsPreserve(text);
      for (let i=0;i<parts.length;i++){
        const w = parts[i];
        panel.content += w;
        panel.el.innerHTML = parseMarkdown(panel.content);
        scrollToBottomIfNeeded();
        const isSentenceEnd = /[.!?…]$/.test(w);
        await sleep(isSentenceEnd ? randomBetween(SENTENCE_PAUSE_MIN,SENTENCE_PAUSE_MAX) : randomBetween(TYPE_MIN_DELAY, TYPE_MAX_DELAY));
      }
    }

    function appendFade(node){
      node.style.opacity='0'; node.style.transform='translateY(16px)';
      el.chatArea?.appendChild(node);
      requestAnimationFrame(()=>{ node.style.transition='all .25s ease'; node.style.opacity='1'; node.style.transform='translateY(0)'; });
    }

    // --- Markdown (spalvos + bold glow + „####“ fix) ---
    function parseMarkdown(input){
      let src = String(input||'');
      src = src.replace(/(^|\n)#{1,6}\s*$/g, '$1'); // plikos antraštės gale

      const HCOL = { 1:'#111827', 2:'#2563eb', 3:'#7c3aed', 4:'#16a34a', 5:'#f59e0b', 6:'#6b7280' };
      let t = escapeHtml(src);

      const STORE=[]; t=t.replace(/```([\s\S]*?)```/g,(_,m)=>`@@CB_${STORE.push(m)-1}@@`);
      t = t.replace(/`([^`]+)`/g, (_,m)=> `<code style="background:rgba(0,0,0,.06);padding:2px 4px;border-radius:4px">${m}</code>`);

      t = t.replace(/^\s*######\s+(.+)$/gm, `<h6 style="margin:.25em 0 .15em;color:${HCOL[6]};font-weight:800">$1</h6>`);
      t = t.replace(/^\s*#####\s+(.+)$/gm, `<h5 style="margin:.3em 0 .2em;color:${HCOL[5]};font-weight:800">$1</h5>`);
      t = t.replace(/^\s*####\s+(.+)$/gm,  `<h4 style="margin:.35em 0 .2em;color:${HCOL[4]};font-weight:800">$1</h4>`);
      t = t.replace(/^\s*###\s+(.+)$/gm,   `<h3 style="margin:.4em 0 .2em;color:${HCOL[3]};font-weight:800">$1</h3>`);
      t = t.replace(/^\s*##\s+(.+)$/gm,    `<h2 style="margin:.5em 0 .25em;color:${HCOL[2]};font-weight:900">$1</h2>`);
      t = t.replace(/^\s*#\s+(.+)$/gm,     `<h1 style="margin:.6em 0 .3em;color:${HCOL[1]};font-weight:900;font-size:1.15em">$1</h1>`);

      t = t.replace(/(^|\n)(?:[-*]\s.+)(?:\n[-*]\s.+)*/g, (block)=>{
        const lines = block.trim().split('\n').map(l=> l.replace(/^[-*]\s+/,'').trim());
        return `\n<ul style="margin:.25em 0 .25em .9em; padding:0; list-style:disc inside;">` +
          lines.map(li=>`<li>${li}</li>`).join('') + `</ul>`;
      });
      t = t.replace(/(^|\n)(?:\d+[.)]\s.+)(?:\n\d+[.)]\s.+)*/g, (block)=>{
        const lines = block.trim().split('\n').map(l=> l.replace(/^\d+[.)]\s+/,'').trim());
        return `\n<ol style="margin:.25em 0 .25em 1.1em; padding:0; list-style:decimal inside;">` +
          lines.map(li=>`<li>${li}</li>`).join('') + `</ol>`;
      });

      t = t.replace(/\*\*([^*]+)\*\*/g, `<strong style="color:#111827;text-shadow:0 0 1px #5b3cc4">$1</strong>`);
      t = t.replace(/\*([^*]+)\*/g, `<em>$1</em>`);
      t = t.replace(/\n/g, '<br>');
      t = t.replace(/@@CB_(\d+)@@/g, (_,i)=> `<pre style="background:rgba(0,0,0,.06);padding:10px;border-radius:10px;overflow:auto"><code>${STORE[Number(i)]||''}</code></pre>`);
      return t;
    }

    function parseErr(e){
      try{
        const data = (e && e.data) ? JSON.parse(e.data) : {};
        return data?.message || 'Klaida';
      }catch(_){ return 'Klaida'; }
    }
    function stripMd(s){ return String(s||'').replace(/`{1,3}[\s\S]*?`{1,3}/g,'').replace(/[*_#>-]/g,''); }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function timeNow(){ return new Date().toLocaleTimeString('lt-LT',{hour:'2-digit',minute:'2-digit'}); }
    function escapeHtml(x){ const d=document.createElement('div'); d.textContent=(x==null?'':String(x)); return d.innerHTML; }

    function safeDelta(s){
      if (!s) return '';
      if (s === '[DONE]') return '';
      let str = String(s);
      try{
        const o = JSON.parse(str);
        if (typeof o === 'string') return o;
        if (o?.text) return String(o.text);
        if (o?.delta && typeof o.delta === 'string') return o.delta;
        if (o?.content && typeof o.content === 'string') return o.content;
        const ch = o?.choices?.[0];
        if (ch?.delta?.content) return String(ch.delta.content);
        if (ch?.message?.content) return String(ch.message.content);
        if (Array.isArray(o?.content) && o.content[0]?.text) return String(o.content[0].text);
      }catch(_){}
      return str;
    }
    function uniqueNonEmpty(arr){ const s=new Set(); const out=[]; (arr||[]).forEach(v=>{ const t=String(v||'').trim(); if(t&&!s.has(t)){ s.add(t); out.push(t);} }); return out; }
    function toast(title, details){
      const n=document.createElement('div');
      n.className='error-notification';
      n.innerHTML = `<div style="font-weight:600;margin-bottom:4px">${escapeHtml(title)}</div>${
        details?`<div style="font-size:12px;opacity:.8">${escapeHtml(details)}</div>`:''}`;
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 6000);
    }
    function debug(){ if (DEBUG) try{ console.log('[PAULE]', ...arguments); }catch(_){ } }
    function firstPanelText(){ const k=Object.keys(state.panels||{}); return k.length? (state.panels[k[0]]?.content||'') : ''; }

    // --- Sprendimų režimai ---
    function startDebate(){
      state.specialMode='debate';
      addSystemMessage('🔁 Pradedamas AI ginčas – kiekvienas modelis pateiks 3–5 argumentus.');
      const fronts = getActiveFront();
      const prompt = state.lastUserText ?
        `${state.lastUserText}\n\nREŽIMAS: GINČAS.\nInstrukcija: Pateik 3–5 stipriausius argumentus, kodėl tavo siūlomas atsakymas/planas yra geriausias. Struktūra: • Argumentas • Įrodymas • Rizika.` :
        'AI ginčas: pateik argumentus.';
      sendAsNewRound(prompt, fronts);
    }
    function startCompromise(){
      const answers = Object.entries(state.lastRound||{}).map(([model,txt])=>`[${model}]: ${txt}`).join('\n\n');
      if (!answers){ toast('Trūksta atsakymų', 'Pirmiausia gauk bent vieną modelio atsakymą.'); return; }
      state.specialMode='compromise';
      addSystemMessage('🤝 Kompromisas: suderiname modelių atsakymus į vieną planą.');
      const prompt = `Žemiau – keli skirtingų modelių atsakymai.\nSujunk į vieną realistišką sprendimą (žingsniai, rizikos, KPI, „next actions“).\n\n${answers}\n\nGrąžink: • Santrauka • Vieningas sprendimas • 3 KPI • Pirmi 5 žingsniai.`;
      sendAsNewRound(prompt, ['auto']);
    }
    function startJudge(){
      const answers = Object.entries(state.lastRound||{}).map(([model,txt])=>`[${model}]: ${txt}`).join('\n\n');
      if (!answers){ toast('Trūksta atsakymų', 'Pirmiausia gauk bent vieną modelio atsakymą.'); return; }
      state.specialMode='judge';
      addSystemMessage('⚖️ Teisėjas vertina atsakymus…');
      const prompt = `Tu esi „Teisėjas“.\nĮvertink pateiktus atsakymus ir parink geriausią.\nGrąžink: • Verdiktas • Kodėl • Kurio modelio idėja • 2 silpnybės kitų variantų • Finalus planas.\n\n${answers}`;
      sendAsNewRound(prompt, ['llama']);
    }
    function sendAsNewRound(prompt, fronts){
      addUserBubble(prompt);
      // NE rašome į input – siunčiam tiesiai
      state.lastUserText = prompt;
      state.isStreaming=false; // nutraukiam jei kas vyko
      resetRound();
      startOrchestrator(prompt, fronts).catch(()=>finalizeRound());
    }

    function addSystemMessage(text){
      if (!el.chatArea) return;
      const n = document.createElement('div'); n.className='message';
      n.innerHTML = `<div class="avatar"><img class="ui-icon" src="${ICONS_BASE}/ai.svg" alt=""></div>
        <div class="bubble" data-model="auto"><div class="bubble-card">
          <div class="msg-content">${parseMarkdown(text)}</div>
          <div class="msg-meta"><span>Paule</span><span>${timeNow()}</span></div>
        </div></div>`;
      appendFade(n); scrollToBottomIfNeeded();
    }

    // Po teisėjo – verčiame į EN ir siunčiam į Flux
    async function generateComicFromJudge(judgeText){
      try{
        const loading = document.createElement('div');
        loading.className='message';
        loading.innerHTML = `<div class="avatar"><img class="ui-icon" src="${ICONS_BASE}/legal-contract.svg" alt=""></div>
          <div class="bubble"><div class="bubble-card">
            <div class="msg-content">📚 Paruošiam komiksą (vertimas → Flux)…</div>
            <div class="msg-meta"><span>Teisėjas</span><span>${timeNow()}</span></div>
          </div></div>`;
        appendFade(loading); scrollToBottomIfNeeded();

        const english = await translateToEnglish(judgeText);
        const payload = { prompt: english || judgeText, style: 'comic', aspect: 'square' };
        const res = await postJSON(FLUX_URL, payload).catch(()=>null);

        let img = (res && (res.image_url || res.url || res.image || (Array.isArray(res.images)&&res.images[0]))) || null;
        if (!img){
          const done = document.createElement('div');
          done.className='message';
          done.innerHTML = `<div class="avatar"><img class="ui-icon" src="${ICONS_BASE}/photo.svg" alt=""></div>
            <div class="bubble"><div class="bubble-card">
              <div class="msg-content">✅ Užduotis pateikta komiksų generatoriui.</div>
              <div class="msg-meta"><span>Flux</span><span>${timeNow()}</span></div>
            </div></div>`;
          appendFade(done); return;
        }

        const card = document.createElement('div');
        card.className='message';
        card.innerHTML = `<div class="avatar"><img class="ui-icon" src="${ICONS_BASE}/photo.svg" alt=""></div>
          <div class="bubble"><div class="bubble-card">
            <div class="msg-content">
              <h3 style="margin:.4em 0 .2em;color:#7c3aed;font-weight:800">Komiksas pagal teisėjo verdiktą</h3>
              <div style="margin:8px 0 10px;font-size:13px;opacity:.8">Prompt (EN): <em>${escapeHtml((english||'').slice(0,280))}${english && english.length>280?'…':''}</em></div>
              <div style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden">
                <img src="${img}" alt="Flux komiksas" style="width:100%;display:block">
              </div>
            </div>
            <div class="msg-meta"><span>Flux</span><span>${timeNow()}</span></div>
          </div></div>`;
        appendFade(card);
        scrollToBottomIfNeeded();
      }catch(e){
        toast('Komikso generavimas nepavyko', e?.message||'Klaida');
      }
    }
    async function translateToEnglish(text){
      try{
        const msg = `Translate the following Lithuanian (or mixed) text into concise English suitable as a visual prompt. Keep key nouns and style words.\n\n=== TEXT ===\n${text}`;
        const res = await postJSON(COMPLETE_URL, { message: msg, models:'gpt-5-mini', max_tokens:512 });
        const t = (res && Array.isArray(res.answers) && res.answers[0]?.text) || '';
        return String(t).trim();
      }catch(_){ return ''; }
    }

    // Tipinę „… rašo …“ animaciją įdedam į <head>, kad veiktų be CSS
    function injectTypingDotsStyle(){
      if (document.getElementById('_paule_dots_css')) return;
      const st = document.createElement('style');
      st.id = '_paule_dots_css';
      st.textContent = `
        .typing-dots { display:inline-flex; gap:4px; align-items:center; opacity:.7; }
        .typing-dots i { display:inline-block; width:6px; height:6px; border-radius:50%; background:var(--fg-muted, #6b7280); animation:_pd 1s infinite; }
        .typing-dots i:nth-child(2){ animation-delay:.15s } .typing-dots i:nth-child(3){ animation-delay:.3s }
        @keyframes _pd { 0%{transform:translateY(0)} 50%{transform:translateY(-2px)} 100%{transform:translateY(0)} }
      `;
      document.head.appendChild(st);
    }

    // Expose viešai
    window.PauleMain = {
      state, sendMessage,
      startDebate, startCompromise, startJudge
    };

  })();
  </script>

  <!-- ===== Google-first AUTH modal (sheet) ===== -->
  <script>
    (function(){
      const AUTH_KEY = 'auth_dismissed_v2';
      function authHtml(){
        return `
          <div style="max-width:520px;margin:0 auto;padding:24px">
            <h3 style="margin:0 0 6px;font-weight:800">Prisijungti</h3>
            <p class="dim" style="margin:0 0 18px">Greitai, paprastai ir saugiai.</p>
            <button id="authGoogle" type="button"
              style="width:100%;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:10px;border:1px solid var(--border,#e5e7eb);background:#fff;cursor:pointer;font-weight:600">
              <img class="ui-icon" src="/assets/icon/google.svg" alt="" style="width:18px;height:18px"> Prisijungti su Google
            </button>
            <div class="dim" style="text-align:center;margin:14px 0">arba</div>
            <div style="display:flex;gap:8px;justify-content:center">
              <button id="authEmailIn" class="btn ghost"  type="button">Prisijungti el. paštu</button>
              <button id="authEmailUp" class="btn ghost"  type="button">Registruotis</button>
            </div>
            <div class="dim" style="margin-top:16px;font-size:12px">
              Tęsdami sutinkate su mūsų <a href="/legal/privacy.html" class="footer-link" data-sheet>privatumo politika</a>.
            </div>
          </div>`;
      }
      async function loadClerk(){
        const c = window.Clerk;
        if (!c || !c.load) return null;
        try { await c.load({ publishableKey: window.__CLERK_PUBLISHABLE_KEY__, frontendApi: window.__CLERK_FRONTEND_API__ }); return c; } catch(_) { return null; }
      }
      window.openAuth = async function(){
        if (!window.PauleModal) return alert('Kraunama…');
        window.PauleModal.open('sheet', authHtml());
        const host = document.getElementById('modalSheet');
        const btnG = host.querySelector('#authGoogle');
        const btnIn= host.querySelector('#authEmailIn');
        const btnUp= host.querySelector('#authEmailUp');

        btnG.onclick = async () => {
          const clerk = await loadClerk();
          if (clerk?.authenticateWithRedirect){
            clerk.authenticateWithRedirect({ strategy:'oauth_google', redirectUrl:'/', redirectUrlComplete:'/' });
          } else if (clerk?.openSignIn){
            clerk.openSignIn({ afterSignInUrl:'/', afterSignUpUrl:'/' });
          } else {
            alert('Kraunama…');
          }
        };
        btnIn.onclick = async () => (await loadClerk())?.openSignIn({ afterSignInUrl:'/', afterSignUpUrl:'/' });
        btnUp.onclick = async () => (await loadClerk())?.openSignUp({  afterSignUpUrl:'/' });

        const closeBtn = document.querySelector('#modal .modal-close');
        const onClose = () => { try{ sessionStorage.setItem(AUTH_KEY,'1'); }catch(_){ } };
        closeBtn?.addEventListener('click', onClose, { once:true });
      };
    })();
  </script>

  <!-- ===== Clerk UI montavimas ===== -->
  <script>
    (function(){
      const root = document.getElementById('clerk-auth');
      const SHOWN_KEY='auth_auto_shown_v2';
      function svgGoogle(){ const s=document.createElementNS('http://www.w3.org/2000/svg','svg');s.setAttribute('viewBox','0 0 533.5 544.3');s.setAttribute('width','16');s.setAttribute('height','16');s.style.marginRight='6px';
        const p1=document.createElementNS(s.namespaceURI,'path');p1.setAttribute('fill','#EA4335');p1.setAttribute('d','M533.5 278.4c0-18.5-1.7-36.4-5-53.6H272v101.5h147.5c-6.4 34.5-25.9 63.7-55.2 83.2v69.1h89.2c52.2-48.1 80-119 80-200.2z');
        const p2=document.createElementNS(s.namespaceURI,'path');p2.setAttribute('fill','#34A853');p2.setAttribute('d','M272 544.3c74 0 136-24.5 181.4-66.5l-89.2-69.1c-24.8 16.6-56.5 26.5-92.3 26.5-70.9 0-131-47.8-152.5-112.1H27.3v70.4C72.3 486.1 165.4 544.3 272 544.3z');
        const p3=document.createElementNS(s.namespaceURI,'path');p3.setAttribute('fill','#4A90E2');p3.setAttribute('d','M119.5 322.9c-5.6-16.6-8.8-34.3-8.8-52.9s3.2-36.3 8.8-52.9V146.7H27.3C9.7 182.4 0 222.1 0 270s9.7 87.6 27.3 123.3l92.2-70.4z');
        const p4=document.createElementNS(s.namespaceURI,'path');p4.setAttribute('fill','#FBBC05');p4.setAttribute('d','M272 107.7c40.3 0 76.5 13.9 105 41.2l-78.7-78.7C408 25.2 346 0 272 0 165.4 0 72.3 58.2 27.3 146.7l92.2 70.4C141 155.8 201.1 107.7 272 107.7z');
        s.append(p1,p2,p3,p4); return s; }
      function button(classes, text, withGoogleIcon){
        const b=document.createElement('button');b.className=classes;b.type='button'; if (withGoogleIcon) b.appendChild(svgGoogle()); b.appendChild(document.createTextNode(text)); return b;
      }
      function renderFallback(){
        if (!root) return;
        root.innerHTML=''; const inBtn=button('btn ghost','Prisijungti',true); inBtn.onclick=()=> window.openAuth ? openAuth() : alert('Kraunama…'); root.append(inBtn);
      }
      window.addEventListener('load', async () => {
        try{
          const clerk = window.Clerk;
          if (!clerk || !clerk.load) { renderFallback(); return; }
          await clerk.load({ publishableKey: window.__CLERK_PUBLISHABLE_KEY__, frontendApi: window.__CLERK_FRONTEND_API__ });
          const rerender = () => {
            if (!root) return;
            root.innerHTML='';
            if (clerk.user){
              const holder=document.createElement('div'); root.appendChild(holder);
              clerk.mountUserButton(holder,{appearance:{elements:{userButtonAvatarBox:'rounded-xl'}}});
            } else {
              const loginBtn = button('btn ghost','Prisijungti',true);
              loginBtn.onclick = () => openAuth(); root.append(loginBtn);
              if (!sessionStorage.getItem(SHOWN_KEY)){
                setTimeout(()=>{ if (!window.Clerk?.user && window.openAuth){ openAuth(); sessionStorage.setItem(SHOWN_KEY,'1'); } },3000);
              }
            }
          };
          rerender(); clerk.addListener(rerender);
        }catch(_){ renderFallback(); }
      });
    })();
  </script>

  <!-- ===== Poraštė ===== -->
  <footer class="site-footer left">
    <a class="footer-link" href="/legal/privacy.html" data-sheet>Privatumo politika</a>
    <span class="sep">•</span>
    <a class="footer-link" href="/legal/refunds.html" data-sheet>Pinigų grąžinimas</a>
    <span class="sep">•</span>
    <a class="footer-link" href="/legal/cookies.html" data-sheet>Slapukų politika</a>
    <span class="sep">•</span>
    <a class="footer-link" href="/legal/ai-disclaimer.html" data-sheet>AI atsakomybės ribojimas</a>
    <span class="sep">•</span>
    <a class="footer-link" href="/legal/fair-use.html" data-sheet>Sąžiningo naudojimo taisyklės</a>

    <div class="legal-note" style="margin-top:8px;font-size:12px;opacity:.75">
      <p>AI atsakymai generuojami automatiškai ir gali būti netikslūs – kritinę informaciją patikrinkite.</p>
      <p>Naudodami paslaugą sutinkate, kad turinys teikiamas „kaip yra“, laikantis mūsų taisyklių.</p>
    </div>
  </footer>

  <!-- ===== Cookie bar ===== -->
  <div id="cookie-bar" role="dialog" aria-live="polite" aria-label="Slapukų pranešimas" style="display:none">
    <div>
      Naudojame slapukus paslaugos veikimui ir tobulinimams. Daugiau –
      <a href="/legal/cookies.html" class="footer-link" data-sheet>Slapukų politikoje</a>.
    </div>
    <div class="actions">
      <button id="cookie-decline" type="button">Atsisakyti</button>
      <button id="cookie-accept" type="button">Sutinku</button>
    </div>
  </div>
  <script>
    (function(){
      const KEY='cookie_choice_v2';
      const bar=document.getElementById('cookie-bar');
      const ok = document.getElementById('cookie-accept');
      const no = document.getElementById('cookie-decline');

      try{
        const v=localStorage.getItem(KEY);
        if(!v) bar.style.display='block';
      }catch(_){ bar.style.display='block'; }

      function setChoice(val){
        try{ localStorage.setItem(KEY,val); }catch(_){}
        bar.style.display='none';
        try{ document.dispatchEvent(new CustomEvent('cookie-preference',{detail:{value:val}})); }catch(_){}
      }

      ok?.addEventListener('click', ()=> setChoice('allow'));
      no?.addEventListener('click',  ()=> setChoice('deny'));
    })();
  </script>

</body>
</html>
