<!DOCTYPE html>
<html lang="lt" data-theme="light" data-backend="vercel">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Paule ‚Äì Premium AI Chat</title>

  <!-- Favicons -->
  <link rel="icon" href="/assets/icon/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/assets/icon/favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/icon/favicon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/assets/icon/apple-touch-icon.png">
  <meta name="theme-color" content="#111827"/>

  <!-- Greitesnis prisijungimas prie to paties hosto (SSE) -->
  <link rel="preconnect" href="/" crossorigin>

  <!-- Pagrindinis CSS -->
  <link rel="stylesheet" href="/assets/css/paule.css?v=1.0.0">

  <!-- ===== PATCH: i≈°dƒóstymas, mobilus, chips apaƒçioje ===== -->
  <style>
  :root{
    --logo-w: 3cm;
    --topbar-h: 66px;
    --ui-icon-filter: none;
  }

  .topbar .brand { min-width: var(--logo-w); }
  .topbar .brand-icon{ width:var(--logo-w)!important; height:auto!important; object-fit:contain; display:block!important; }
  .topbar img, .topbar svg{ max-height: calc(var(--topbar-h) - 16px); }

  [data-theme="dark"] .ui-icon{ filter: invert(1) brightness(1.08) contrast(1.05); }
  [data-theme="dark"] img:not(.ui-icon){ filter:none !important; }

  .models-in-topbar{ gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .topbar{ position:sticky; top:0; left:0; right:0; z-index:1000; }
  #chatArea{ padding-top: calc(3cm + 6px) !important; z-index:1; }
  @media (max-height: 750px){ #chatArea{ padding-top: 24px !important; } }

  .message.user{ flex-direction:row-reverse; }
  .message.user .bubble{ margin-left:auto; }
  .bottom-section{ z-index:1100; padding-bottom:max(10px, env(safe-area-inset-bottom)); }

  @media (max-width: 768px){
    .topbar{
      display:grid;
      grid-template-areas: "brand actions" "models models";
      grid-template-columns:auto 1fr; height:auto; padding-bottom:10px; row-gap:8px;
    }
    .brand{ grid-area:brand }
    .models-in-topbar{ grid-area:models; display:flex!important; max-width:100%; }
    .top-actions{ grid-area:actions; justify-content:flex-end }
    .top-actions [data-nav="community"], .theme-anchor{ display:none!important; }
  }
  @media (max-width:1024px){
    .layout{ display:grid; grid-template-columns:0 1fr !important; }
    .sidebar{
      display:block!important; position:fixed; top:var(--topbar-h); left:-320px;
      width:300px; height:calc(100vh - var(--topbar-h));
      background:var(--bg-primary); border-right:1px solid var(--border);
      box-shadow:0 18px 60px rgba(0,0,0,.14); z-index:1350;
      transition:left .25s ease; overflow:auto;
    }
    .sidebar.open{ left:0; }
    .drawer-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      opacity:0; visibility:hidden; pointer-events:none; transition:.2s; z-index:1200;
    }
    .drawer-overlay.show{ opacity:1; visibility:visible; pointer-events:auto; }
    .mobile-only{ display:block!important; }
    .bottom-section{ left:var(--gutter)!important; right:var(--gutter)!important; }
  }

  /* ===== Chips (follow + decision) apaƒçioje ir centruotos ===== */
  .follow-suggest-bar{
    display:none; gap:8px; flex-wrap:wrap; justify-content:center;
    margin:8px 0 6px 0; padding:8px 0 2px;
    overflow-x:auto; -webkit-overflow-scrolling:touch;
  }
  .follow-suggest-bar.show{ display:flex; }
  .suggest-chip, .decision-chip{
    display:inline-flex; align-items:center; white-space:nowrap;
    padding:6px 10px; border:1px solid var(--border); border-radius:12px;
    font-size:13px; line-height:1;
    background:var(--bg-secondary,rgba(0,0,0,0.03));
    cursor:pointer; user-select:none; transition:background .15s, border-color .15s, transform .05s;
  }
  .suggest-chip:hover, .decision-chip:hover{ background:rgba(0,0,0,.05); }
  .suggest-chip:active, .decision-chip:active{ transform:scale(.98); }

  /* spalvoti apvadai ‚ÄûAI ginƒças / Teisƒójas / Kompromisas‚Äú */
  .decision-chip[data-mode="debate"]{ border-color:#7c3aed; }
  .decision-chip[data-mode="judge"]{  border-color:#16a34a; }
  .decision-chip[data-mode="compromise"]{ border-color:#2563eb; }

  /* Inline deck ‚Äì ƒØ paƒçiƒÖ ƒØvestƒØ */
  .input-container{ position:relative; }
  .input-suggest-deck{
    position:absolute; left:8px; right:56px; bottom:8px;
    display:none; align-items:center; gap:6px; padding:6px;
    border:1px solid var(--border); border-radius:10px;
    background:var(--bg-primary); box-shadow:0 6px 18px rgba(0,0,0,.06);
    overflow-x:auto; -webkit-overflow-scrolling:touch; z-index:5;
  }
  .input-suggest-deck.show{ display:flex; }
  .input-suggest-deck .suggest-chip{ font-size:12px; padding:6px 9px; }

  /* daugiau vietos ≈æinutei, kad kortelƒós neu≈ædengt≈≥ */
  .message-input{ padding-bottom:44px !important; }
  @media (max-width:480px){
    .input-suggest-deck{ left:6px; right:52px; bottom:6px; }
    .message-input{ padding-bottom:48px !important; }
  }

  /* Global wait (‚ÄûAI mƒÖsto‚Ä¶‚Äú) */
  ._ai-wait{ display:flex; gap:10px; align-items:center; opacity:.85; font-size:14px; margin:10px auto; width:fit-content; }
  ._ai-wait .dots{ display:inline-flex; gap:4px }
  ._ai-wait .dots span{ width:6px; height:6px; border-radius:50%; background:currentColor; opacity:.4; display:inline-block; animation:bl .9s infinite alternate }
  ._ai-wait .dots span:nth-child(2){ animation-delay:.15s } ._ai-wait .dots span:nth-child(3){ animation-delay:.3s }
  @keyframes bl{ to{ opacity:1; transform:translateY(-2px) } }

  /* Klaidos kortelƒó */
  .error-card{ background:var(--bg-danger,rgba(220,20,60,.08)); border:1px solid var(--border-danger,rgba(220,20,60,.35)); }

  /* Scroll-lock mygtukas ‚ÄûƒÆ naujausiƒÖ‚Äú */
  .jump-latest{
    position:fixed; right:16px; bottom:92px; z-index:1200;
    display:none; align-items:center; gap:6px;
    padding:8px 10px; border:1px solid var(--border);
    background:var(--bg-primary); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.12); cursor:pointer;
    font-size:13px;
  }
  .jump-latest.show{ display:flex; }

  /* Svarbu: joki≈≥ :has() ‚Äì valdome klase */
  .bubble.hidden{ display:none !important; }
  </style>

  <!-- üîß Konfig≈´racija -->
  <script>
    (function () {
      var MODE=(document.documentElement.getAttribute('data-backend')||'').trim().toLowerCase()==='vercel'?'vercel':'wp';
      var restBase=MODE==='vercel'?'/api':'/wp-json/paule/v1';
      var routes={
        base:restBase, stream:restBase+'/stream', models:restBase+'/models', diagnostics:restBase+'/diagnostics',
        comicCreate:restBase+'/comic/create', fluxCreate:restBase+'/flux/create',
        musicCreate:restBase+'/music/create', musicStatus:restBase+'/music/status',
        runwayImage:restBase+'/runway/image', runwayStatus:restBase+'/runway/status'
      };
      var CFG={mode:MODE,restBase:routes.base,restStream:routes.stream,restStreamSSE:routes.stream,sseDefault:1,
        pluginBase:'/assets',iconsBase:'/assets/icon',featuresBase:'/assets/features',routes:routes,version:'paule-1.0.5'};
      window.PAULE_CONFIG=CFG; window.AUGAM_CONFIG=CFG;
      try{Object.defineProperty(window,'API_BASE',{configurable:true,get:function(){return CFG.restBase;},set:function(_){}});}catch(e){}
      window.__SET_API_BASE__=function(v){};
    })();
  </script>

  <!-- ‚úÖ Bridge WP->/api -->
  <script>
    (function(){
      'use strict';
      try{
        var restBase=(window.PAULE_CONFIG&&window.PAULE_CONFIG.restBase)||'/api';
        if(window.EventSource){
          var OrigES=window.EventSource;
          window.EventSource=function(url,opts){
            try{url=String(url).replace(/\/wp-json\/(?:augam|paule)\/v1(\/|$)/,'/api$1').replace(/\/(?:augam|paule)\/v1(\/|$)/,'/api$1');}catch(_){}
            return new OrigES(url,opts);
          };
          window.EventSource.prototype=OrigES.prototype;
        }
        if(window.fetch){
          var origFetch=window.fetch;
          window.fetch=function(input,init){
            try{
              var u=(typeof input==='string')?input:(input&&input.url);
              if(u){
                var nu=String(u).replace(/\/wp-json\/(?:augam|paule)\/v1(\/|$)/,'/api$1').replace(/\/(?:augam|paule)\/v1(\/|$)/,'/api$1');
                if(nu!==u) input=(typeof input==='string')?nu:new Request(nu,input);
              }
            }catch(_){}
            return origFetch(input,init);
          };
        }
        window.__FORCE_STREAM_ENDPOINT__=restBase.replace(/\/+$/,'')+'/stream';
      }catch(e){console.warn('[PAULE bridge] warning:',e);}
    })();
  </script>

  <!-- ü©π HOTFIX: jei POST /api/stream?mode=once grƒØ≈æta SSE, paverƒçiam ƒØ JSON -->
  <script>
    (function(){
      'use strict';
      if (!window.fetch) return;
      const prevFetch = window.fetch;

      async function toJsonFromSSE(resp, models){
        const reader  = resp.body?.getReader?.();
        if (!reader) return null;
        const dec = new TextDecoder();
        let buf = '', text = '';
        for(;;){
          const it = await reader.read();
          if (it.done) break;
          buf += dec.decode(it.value, {stream:true});
          let idx;
          while ((idx = buf.indexOf('\n\n')) >= 0){
            const frame = buf.slice(0, idx).trim(); buf = buf.slice(idx+2);
            if (!frame) continue;
            const dataLine = frame.split('\n').find(l => l.startsWith('data:'));
            if (!dataLine) continue;
            const payload = dataLine.replace(/^data:\s*/,'').trim();
            if (payload === '[DONE]') { buf=''; break; }
            try{
              const j = JSON.parse(payload);
              const piece = j?.choices?.[0]?.delta?.content ?? j?.text ?? '';
              if (typeof piece === 'string') text += piece;
            }catch(_){}
          }
        }
        const answers = (models && models.length ? models : ['auto']).map(m => ({ model:m, text }));
        return { ok:true, answers };
      }

      window.fetch = async function(input, init){
        const url  = typeof input==='string' ? input : (input && input.url) || '';
        const meth = (init && init.method) || (typeof input!=='string' && input && input.method) || 'GET';
        const isStreamOnce = /\/api\/stream(?:\?|$)/.test(url) && /mode=once/.test(url) && String(meth).toUpperCase()==='POST';
        if (!isStreamOnce) return prevFetch(input, init);

        let models = [];
        try {
          const raw = (init && init.body) ? String(init.body) : '';
          if (raw) {
            const b = JSON.parse(raw);
            if (typeof b.models === 'string') { models = b.models.split(',').map(s=>s.trim()).filter(Boolean); }
          }
        } catch(_){}

        const resp = await prevFetch(input, init);
        const ct   = (resp.headers.get('content-type')||'').toLowerCase();
        if (ct.includes('text/event-stream')) {
          const json = await toJsonFromSSE(resp, models);
          if (json) {
            return new Response(JSON.stringify(json), {
              status: 200,
              headers: { 'Content-Type':'application/json; charset=utf-8', 'Cache-Control':'no-store' }
            });
          }
        }
        return resp;
      };
    })();
  </script>

  <!-- Globalus alias -->
  <script>
    window.sendMessage = function(){
      if (window.PauleMain && typeof window.PauleMain.sendMessage === 'function'){
        return window.PauleMain.sendMessage();
      }
    };
  </script>
</head>
<body>

  <!-- ===== TOPBAR ===== -->
  <header class="topbar" data-no-clip="true" id="topbar" role="banner">
    <a class="brand" href="/" aria-label="Paule">
      <img id="brandLogo" class="brand-icon" src="/assets/icon/paule-logo.webp" alt="Paule logotipas">
    </a>

    <nav class="models-in-topbar" aria-label="Modeliai" id="modelList">
      <button class="model-pill active" data-model="auto" aria-pressed="true" type="button"><img class="ui-icon" src="/assets/icon/paule-icon.webp" alt=""> Paule</button>
      <button class="model-pill" data-model="chatgpt" type="button"><img class="ui-icon" src="/assets/icon/chatgpt.svg" alt=""> ChatGPT</button>
      <button class="model-pill" data-model="claude" type="button"><img class="ui-icon" src="/assets/icon/claude-seeklogo.svg" alt=""> Claude</button>
      <button class="model-pill" data-model="gemini" type="button"><img class="ui-icon" src="/assets/icon/gemini.svg" alt=""> Gemini</button>
      <button class="model-pill" data-model="grok" type="button"><img class="ui-icon" src="/assets/icon/xAI.svg" alt=""> Grok</button>
      <button class="model-pill" data-model="deepseek" type="button"><img class="ui-icon" src="/assets/icon/deepseek.svg" alt=""> DeepSeek</button>
      <button class="model-pill" data-model="llama" type="button"><img class="ui-icon" src="/assets/icon/llama.svg" alt=""> Llama</button>
    </nav>

    <div class="top-actions" id="topActions" role="navigation" aria-label="Pagrindiniai veiksmai">
      <a class="btn ghost" data-nav="community" href="/community" role="button">
        <img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> Bendruomenƒó
      </a>
      <button class="btn ghost" id="btnNewChat" type="button">
        <img class="ui-icon" src="/assets/icon/nav-new-chat.svg" alt=""> Naujas pokalbis
      </button>

      <div class="login-anchor theme-anchor">
        <button class="btn ghost" id="btnTheme" type="button" aria-haspopup="menu" aria-expanded="false"><img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> Tema</button>
        <div class="login-dropdown" id="themeDropdown" role="menu" aria-label="Temos pasirinkimas">
          <button class="btn" data-theme="light" type="button">≈†viesi</button>
          <button class="btn" data-theme="dark" type="button">Tamsi</button>
        </div>
      </div>

      <div class="login-anchor" id="loginAnchor">
        <button class="btn ghost" id="btnLogin" type="button" aria-haspopup="menu" aria-expanded="false">
          <img class="ui-icon" src="/assets/icon/user.svg" alt=""> Prisijungti
        </button>
        <div class="login-dropdown" id="loginDropdown" role="menu" aria-label="Prisijungimas">
          <a class="btn" id="googleLoginBtn" href="#"><img class="ui-icon" src="/assets/icon/google.svg" alt=""> Prisijungti su Google</a>
          <a class="btn" id="emailLoginBtn"  href="#"><img class="ui-icon" src="/assets/icon/mail.svg"   alt=""> Prisijungti el. pa≈°tu</a>
        </div>
      </div>

      <button class="btn ghost mobile-toggle" id="btnMobile" aria-label="Meniu (mobilus)" type="button">
        <img class="ui-icon" src="/assets/icon/nav-menu.svg" alt=""> Meniu
      </button>
    </div>
  </header>

  <div id="drawerOverlay" class="drawer-overlay" aria-hidden="true"></div>

  <div class="layout" id="layoutRoot">
    <aside class="sidebar" id="sidebar" role="complementary" aria-label="≈†oninƒó navigacija">
      <section class="side-section mobile-only" style="display:none" id="mobileQuick">
        <a class="project-item" href="/community"><img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> Bendruomenƒó</a>
        <div class="control-group" style="display:flex;gap:8px;margin-top:8px">
          <button class="chip" data-set-theme="light" type="button"><img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> ≈†viesi</button>
          <button class="chip" data-set-theme="dark" type="button"><img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> Tamsi</button>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">AI specialistai</div>
        <div class="specialist-grid" id="specialistGrid">
          <a class="chip" href="#spec-sefas" data-route="/spec/sefas" data-spec="sefas"><img class="ui-icon" src="/assets/icon/chef-knife.svg" alt=""> ≈†efas</a>
          <a class="chip" href="#spec-marketing" data-route="/spec/marketing" data-spec="marketing"><img class="ui-icon" src="/assets/icon/marketing-megaphone.svg" alt=""> Marketing</a>
          <a class="chip" href="#spec-pardavimai" data-route="/spec/pardavimai" data-spec="pardavimai"><img class="ui-icon" src="/assets/icon/sales-handshake.svg" alt=""> Pardavimai</a>
          <a class="chip" href="#spec-verslas" data-route="/spec/verslas" data-spec="verslas"><img class="ui-icon" src="/assets/icon/business-strategy.svg" alt=""> Verslas</a>
          <a class="chip" href="#spec-finansai" data-route="/spec/finansai" data-spec="finansai"><img class="ui-icon" src="/assets/icon/finance-investment.svg" alt=""> Finansai</a>
          <a class="chip" href="#spec-keliones" data-route="/spec/keliones" data-spec="keliones"><img class="ui-icon" src="/assets/icon/travel-map.svg" alt=""> Kelionƒós</a>
          <a class="chip" href="#spec-renginiai" data-route="/spec/renginiai" data-spec="renginiai"><img class="ui-icon" src="/assets/icon/event-planning.svg" alt=""> Renginiai</a>
          <a class="chip" href="/spec/goal.html" data-route="/spec/goal.html" data-spec="goal"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Tiksl≈≥ ≈æemƒólapis</a>
          <a class="chip" href="#spec-teise" data-route="/spec/teisininkas" data-spec="teisininkas"><img class="ui-icon" src="/assets/icon/legal-contract.svg" alt=""> Teisininkas</a>
          <a class="chip" href="#spec-psichologas" data-route="/spec/psichologas" data-spec="psichologas"><img class="ui-icon" src="/assets/icon/psychology-brain.svg" alt=""> Psichologas</a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Aktyvumas</div>
        <div class="community-pings" id="communityPings" aria-live="polite">
          <div class="ping"><img class="ui-icon" src="/assets/icon/music.svg" alt=""> @Mantas ƒØkƒólƒó dainƒÖ ‚ÄûVasaros vƒójas‚Äú</div>
          <div class="ping"><img class="ui-icon" src="/assets/icon/photo.svg" alt=""> @Ieva pridƒójo 3 nuotraukas</div>
          <div class="ping"><img class="ui-icon" src="/assets/icon/video-library.svg" alt=""> @Ruta publikavo ‚ÄûReklama-15s‚Äú</div>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#dainos">Dainos</a></div>
        <div class="library-grid thumbs" id="songsFeed">
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>‚ÄûVasaros vƒójas‚Äú</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>‚ÄûNakties ≈°viesos‚Äú</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>‚ÄûMiesto pulsas‚Äú</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#nuotraukos">Nuotraukos</a></div>
        <div class="library-grid thumbs" id="photosFeed">
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Produktas</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Kampanija</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Vir≈°elis</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#video">Video</a></div>
        <div class="library-grid thumbs" id="videosFeed">
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Reklama 15s</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Pristatymas</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>U≈ækulisiai</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Projektai</div>
        <div class="control-group" id="projectsList">
          <div class="project-item" data-project="new" role="button" tabindex="0">
            <img class="ui-icon" src="/assets/icon/plus.svg" alt=""> Naujas projektas
          </div>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Pokalbi≈≥ istorija</div>
        <div class="control-group" id="historyList"></div>
      </section>
    </aside>

    <main class="main" role="main">
      <div class="chat-area" id="chatArea">
        <section class="welcome" id="welcome" aria-label="Pradinis ekranas">
          <h1 class="hero-title">KAIP GALIU PADƒñTI ≈†IANDIEN?</h1>
          <p>Pasirinkite AI specialistƒÖ kairƒóje arba pradƒókite pokalbƒØ ≈æemiau. Vir≈°uje galite rinktis vienƒÖ ar kelis modelius. üëá</p>

          <div class="welcome-grid">
            <a class="welcome-card" href="#" data-action="song">
              <img src="/assets/hero/music.webp" alt="">
              <b>Sukurti dainƒÖ</b><span>Pasveikink draugƒÖ unikalia gimtadienio daina.</span>
            </a>
            <a class="welcome-card" href="#" data-action="song-photo">
              <img src="/assets/hero/song-photo.webp" alt="">
              <b>Daina i≈° nuotraukos</b><span>ƒÆkelk kadrƒÖ ir gauk originaliƒÖ melodijƒÖ su ≈æod≈æiais.</span>
            </a>
            <a class="welcome-card" href="#" data-action="photo">
              <img src="/assets/hero/photo.webp" alt="">
              <b>Sukurti nuotraukƒÖ</b><span>Produktai, scenos, peiza≈æai, selfiai ir animacija.</span>
            </a>
            <a class="welcome-card" href="#" data-action="mindmap">
              <img src="/assets/hero/mindmap.webp" alt="">
              <b>Minƒçi≈≥ ≈æemƒólapis</b><span>Susitelk ƒØ esmƒô ir didink produktyvumƒÖ.</span>
            </a>
            <a class="welcome-card" href="/spec/goal.html">
              <img src="/assets/hero/goals.webp" alt="">
              <b>Tiksl≈≥ sistema (AI)</b><span>Vizija ‚Üí u≈æduotys ‚Üí real≈´s rezultatai.</span>
            </a>
            <a class="welcome-card" href="#" data-action="video">
              <img src="/assets/hero/video.webp" alt="">
              <b>Sukurti video</b><span>Reels ir Stories i≈° teksto ar nuotrauk≈≥.</span>
            </a>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- ===== BOTTOM INPUT ===== -->
  <div class="bottom-section after-message" id="bottomSection" data-responsive="true">
    <!-- ‚ñ∂ Follow-up + Decision (apaƒçioje) -->
    <div class="follow-suggest-bar" id="followSuggestBar" aria-live="polite"></div>

    <div class="input-bar" id="inputBar">
      <div class="input-container" id="inputContainer">
        <label for="messageInput" class="sr-only">≈Ωinutƒó specialistui</label>
        <textarea class="message-input" id="messageInput" rows="1" placeholder="≈Ωinutƒó specialistui‚Ä¶" autocomplete="on" autocapitalize="sentences" autocorrect="on" spellcheck="true"></textarea>
        <button class="send-btn" id="sendBtn" aria-label="Si≈≥sti" type="button">
          <img class="ui-icon" src="/assets/icon/arrow-top.svg" alt="">
        </button>
        <!-- ‚ñ∂ Inline kortelƒós ƒØ paƒçiƒÖ ƒØvestƒØ -->
        <div class="input-suggest-deck" id="inputSuggestDeck" aria-live="polite"></div>
      </div>
    </div>

    <div class="tools-bar" id="toolsBar" role="toolbar" aria-label="ƒÆrankiai">
      <div class="tool" data-tool="mindmap" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Mindmap</div>
      <div class="tool" data-tool="photo" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-photo.svg" alt=""> Foto</div>
      <div class="tool" data-tool="file" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-file.svg" alt=""> Failas</div>
      <div class="tool" data-tool="song" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-music.svg" alt=""> Sukurti dainƒÖ</div>
      <div class="tool" data-tool="video" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/video-plus.svg" alt=""> Sukurti video</div>
      <div class="tool" data-tool="goals" tabindex="0" role="button"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Tiksl≈≥ sistema</div>
    </div>
  </div>

  <!-- ===== Orchestrator JS (viskas viename) ===== -->
  <script>
  (function(){
    'use strict';
    const root=document.documentElement;
    const sidebar=document.getElementById('sidebar');
    const overlay=document.getElementById('drawerOverlay');
    const btnMobile=document.getElementById('btnMobile');
    const msgInput=document.getElementById('messageInput');
    const sendBtn=document.getElementById('sendBtn');
    const btnTheme=document.getElementById('btnTheme');
    const themeDropdown=document.getElementById('themeDropdown');
    const logo=document.getElementById('brandLogo');
    const modelList=document.getElementById('modelList');
    const chatArea  = document.getElementById('chatArea');
    const followBar = document.getElementById('followSuggestBar');
    const inputDeck = document.getElementById('inputSuggestDeck');

    const API_BASE   = (window.PAULE_CONFIG&&window.PAULE_CONFIG.restBase)  || '/api';
    const SSE_URL    = (window.PAULE_CONFIG&&window.PAULE_CONFIG.restStream)|| '/api/stream';
    const COMPLETE_URL = API_BASE + '/complete';
    const SUGGEST_URL  = API_BASE + '/suggest';

    /* ===== Modeli≈≥ ≈æemƒólapis (front -> back) ===== */
    const FRONT_TO_BACK={
      auto:'gpt-4o-mini',
      chatgpt:'gpt-4o-mini',
      claude:'claude-4-sonnet',
      gemini:'gemini-2.5-flash',
      grok:'grok-4',
      deepseek:'deepseek-chat',
      llama:'meta-llama/Llama-4-Scout-17B-16E-Instruct'
    };
    /* ≈†itie ‚Äì JSON fallback (ne SSE) */
    const NON_SSE_FRONT = new Set(['claude','gemini','grok']);

    /* ===== Bendra round b≈´sena ===== */
    const state = {
      chatId:null,
      panels:{},          // frontId -> { el, content, done }
      startedOrder:[],    // pagal pirmƒÖ delta
      firstStarted:null,
      pending:0,          // kiek front≈≥ dar laukiam
      errors:[],          // {front, name, msg}
      hasAnyText:false,
      suggestShown:false
    };

    /* ===== Tema / UI smulkmenos ===== */
    function setLogoByTheme(){
      const dark = root.getAttribute('data-theme') === 'dark';
      logo.src = dark ? '/assets/icon/paule-logo-dark.webp' : '/assets/icon/paule-logo.webp';
      logo.setAttribute('alt', dark ? 'Paule logotipas ‚Äì tamsi tema' : 'Paule logotipas ‚Äì ≈°viesi tema');
    }
    setLogoByTheme();
    new MutationObserver(setLogoByTheme).observe(root,{attributes:true,attributeFilter:['data-theme']});

    // dropdown atidarymas/u≈ædarymas
    btnTheme?.addEventListener('click', (e)=>{
      e.preventDefault();
      const open = !themeDropdown?.classList.contains('open');
      themeDropdown?.classList.toggle('open', open);
      btnTheme.setAttribute('aria-expanded', String(open));
    });
    themeDropdown?.addEventListener('click', (e)=>{
      const b=e.target.closest('[data-theme]'); if(!b) return;
      root.setAttribute('data-theme', b.getAttribute('data-theme'));
      themeDropdown.classList.remove('open');
      btnTheme.setAttribute('aria-expanded','false');
      setLogoByTheme();
    });

    function openDrawer(){ sidebar.classList.add('open'); overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeDrawer(){ sidebar.classList.remove('open'); overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
    btnMobile?.addEventListener('click', openDrawer);
    overlay?.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    // ===== Modeli≈≥ pasirinkimas (multi-pick; ‚Äûauto‚Äú ‚Äì vienas)
    modelList.addEventListener('click', (e)=>{
      const b=e.target.closest('.model-pill'); if(!b) return;
      if(b.dataset.model==='auto'){
        modelList.querySelectorAll('.model-pill').forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false'); });
        b.classList.add('active'); b.setAttribute('aria-pressed','true');
      }else{
        b.classList.toggle('active');
        b.setAttribute('aria-pressed', b.classList.contains('active')?'true':'false');
        const autoBtn = modelList.querySelector('.model-pill[data-model="auto"]');
        autoBtn?.classList.remove('active');
        autoBtn?.setAttribute('aria-pressed','false');
      }
    });

    // ===== Helpers
    function timeNow(){ return new Date().toLocaleTimeString('lt-LT',{hour:'2-digit',minute:'2-digit'}); }
    function escapeHtml(x){ const d=document.createElement('div'); d.textContent=(x==null?'':String(x)); return d.innerHTML; }
    function stripMd(s){ return String(s||'').replace(/`{1,3}[\s\S]*?`{1,3}/g,'').replace(/[*_#>-]/g,''); }
    function uniqueNonEmpty(arr){ const s=new Set(); const out=[]; (arr||[]).forEach(v=>{ const t=String(v||'').trim(); if(t&&!s.has(t)){ s.add(t); out.push(t);} }); return out; }

    // ===== Markdown su spalvom + juodu bold ir "####" mirgƒójimo fix
    function parseMarkdown(input){
      let src = String(input||'');

      // pa≈°alinam "plikas" antra≈°tes streamo pabaigoje (pvz. tik #### be teksto)
      src = src.replace(/(^|\n)#{1,6}\s*$/g, '$1');

      const HCOL = { 1:'#111827', 2:'#2563eb', 3:'#7c3aed', 4:'#16a34a', 5:'#f59e0b', 6:'#6b7280' };
      let t = escapeHtml(src);

      // Saugojam ```code```
      const STORE=[]; t=t.replace(/```([\s\S]*?)```/g,(_,m)=>`@@CB_${STORE.push(m)-1}@@`);

      // Inline code
      t = t.replace(/`([^`]+)`/g, (_,m)=> `<code style="background:rgba(0,0,0,.06);padding:2px 4px;border-radius:4px">${m}</code>`);

      // Headings
      t = t.replace(/^\s*######\s+(.+)$/gm, `<h6 style="margin:.25em 0 .15em;color:${HCOL[6]};font-weight:800">$1</h6>`);
      t = t.replace(/^\s*#####\s+(.+)$/gm, `<h5 style="margin:.3em 0 .2em;color:${HCOL[5]};font-weight:800">$1</h5>`);
      t = t.replace(/^\s*####\s+(.+)$/gm,  `<h4 style="margin:.35em 0 .2em;color:${HCOL[4]};font-weight:800">$1</h4>`);
      t = t.replace(/^\s*###\s+(.+)$/gm,   `<h3 style="margin:.4em 0 .2em;color:${HCOL[3]};font-weight:800">$1</h3>`);
      t = t.replace(/^\s*##\s+(.+)$/gm,    `<h2 style="margin:.5em 0 .25em;color:${HCOL[2]};font-weight:900">$1</h2>`);
      t = t.replace(/^\s*#\s+(.+)$/gm,     `<h1 style="margin:.6em 0 .3em;color:${HCOL[1]};font-weight:900;font-size:1.15em">$1</h1>`);

      // SƒÖra≈°ai
      t = t.replace(/(^|\n)(?:[-*]\s.+)(?:\n[-*]\s.+)*/g, (block)=>{
        const lines = block.trim().split('\n').map(l=> l.replace(/^[-*]\s+/,'').trim());
        return `\n<ul style="margin:.25em 0 .25em .9em; padding:0; list-style:disc inside;">` +
          lines.map(li=>`<li>${li}</li>`).join('') + `</ul>`;
      });
      t = t.replace(/(^|\n)(?:\d+[.)]\s.+)(?:\n\d+[.)]\s.+)*/g, (block)=>{
        const lines = block.trim().split('\n').map(l=> l.replace(/^\d+[.)]\s+/,'').trim());
        return `\n<ol style="margin:.25em 0 .25em 1.1em; padding:0; list-style:decimal inside;">` +
          lines.map(li=>`<li>${li}</li>`).join('') + `</ol>`;
      });

      // **bold** ‚Äì juodas su subtiliu violetiniu glow
      t = t.replace(/\*\*([^*]+)\*\*/g, `<strong style="color:#111827; text-shadow:0 0 1px #5b3cc4">$1</strong>`);
      t = t.replace(/\*([^*]+)\*/g, `<em>$1</em>`);

      // Newlines
      t = t.replace(/\n/g, '<br>');

      // GrƒÖ≈æinam code blocks
      t = t.replace(/@@CB_(\d+)@@/g, (_,i)=> `<pre style="background:rgba(0,0,0,.06);padding:10px;border-radius:10px;overflow:auto"><code>${STORE[Number(i)]||''}</code></pre>`);

      return t;
    }

    // ===== Scroll lock + ‚ÄûƒÆ naujausiƒÖ‚Äú
    let stickToBottom = true;
    const jumpBtn = (()=>{
      const b=document.createElement('button');
      b.className='jump-latest';
      b.innerHTML='<img class="ui-icon" src="/assets/icon/arrow-down.svg" alt=""> ƒÆ naujausiƒÖ';
      b.onclick=()=>{ chatArea.scrollTo({top:chatArea.scrollHeight, behavior:'smooth'}); b.classList.remove('show'); stickToBottom=true; };
      document.body.appendChild(b);
      return b;
    })();
    chatArea.addEventListener('scroll', ()=>{
      stickToBottom = (chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 80);
      jumpBtn.classList.toggle('show', !stickToBottom);
    });
    function autoscrollIfNeeded(){
      if (stickToBottom) chatArea.scrollTo({ top: chatArea.scrollHeight });
      else jumpBtn.classList.add('show');
    }

    function showGlobalWait(){
      if (document.querySelector('._ai-wait')) return;
      const w = document.createElement('div');
      w.className='_ai-wait';
      w.setAttribute('aria-live','polite');
      w.innerHTML = `<div class="dots" aria-hidden="true"><span></span><span></span><span></span></div><div>AI mƒÖsto, palaukite akimirkƒÖ‚Ä¶</div>`;
      chatArea?.appendChild(w);
      autoscrollIfNeeded();
    }
    function hideGlobalWait(){ const w=document.querySelector('._ai-wait'); if (w){ w.remove(); } }

    // ===== ≈Ωinuƒçi≈≥ burbulai
    function appendUserBubble(text){
      document.getElementById('welcome')?.remove();
      const wrap=document.createElement('div'); wrap.className='message user';
      wrap.innerHTML = `
        <div class="avatar"><img class="ui-icon" src="/assets/icon/user.svg" alt=""></div>
        <div class="bubble" data-model="user">
          <div class="bubble-card">
            <button class="copy-btn" title="Kopijuoti"
              type="button"
              onclick="(function(b){try{const t=b.closest('.bubble-card')?.querySelector('.msg-content')?.innerText||'';navigator.clipboard.writeText(t).catch(()=>{});b.classList.add('ok');setTimeout(()=>b.classList.remove('ok'),900);}catch(_){}})(this)"
              style="position:absolute;right:8px;top:8px;font-size:12px;border:1px solid var(--border);background:var(--bg-primary);padding:4px 6px;border-radius:6px;cursor:pointer;opacity:.8">‚ßâ</button>
            <div class="msg-content"></div>
            <div class="msg-meta"><span class="model-tag">J≈´s</span><span>${timeNow()}</span></div>
          </div>
        </div>`;
      chatArea.appendChild(wrap);
      wrap.querySelector('.msg-content').textContent=text;
      autoscrollIfNeeded();
      return wrap;
    }

    function ensurePanel(frontId){
      if (state.panels[frontId]) return state.panels[frontId];
      const n = document.createElement('div'); n.className='message';
      n.innerHTML = `<div class="avatar"><img class="ui-icon" src="/assets/icon/ai.svg" alt=""></div>
        <div class="bubble" data-model="${frontId}">
          <div class="bubble-card">
            <button class="copy-btn" title="Kopijuoti" type="button"
             onclick="(function(b){const t=b.closest('.bubble-card')?.querySelector('.msg-content')?.innerText||'';navigator.clipboard.writeText(t).catch(()=>{});b.classList.add('ok');setTimeout(()=>b.classList.remove('ok'),900)})(this)"
             style="position:absolute;right:8px;top:8px;font-size:12px;border:1px solid var(--border);background:var(--bg-primary);padding:4px 6px;border-radius:6px;cursor:pointer;opacity:.8">‚ßâ</button>
            <div class="msg-content"></div>
            <div class="msg-meta"><span class="model-tag">${frontId}</span><span>${timeNow()}</span></div>
          </div>
        </div>`;
      n.style.opacity='0'; n.style.transform='translateY(16px)';
      chatArea?.appendChild(n);
      requestAnimationFrame(()=>{ n.style.transition='all .25s ease'; n.style.opacity='1'; n.style.transform='translateY(0)'; });
      const contentEl = n.querySelector('.msg-content');
      const panel = { el: contentEl, content:'', done:false };
      state.panels[frontId]=panel;
      state.startedOrder.push(frontId);
      return panel;
    }

    // ===== Orchestrator
    function resetRound(){
      state.chatId = 'chat_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
      state.panels={}; state.startedOrder=[]; state.firstStarted=null;
      state.pending=0; state.errors=[]; state.hasAnyText=false; state.suggestShown=false;
      followBar.innerHTML=''; followBar.classList.remove('show');
      showGlobalWait();
    }

    async function startOrchestrator(text, fronts){
      const streamFronts = fronts.filter(f=> !NON_SSE_FRONT.has(f));
      const jsonFronts   = fronts.filter(f=>  NON_SSE_FRONT.has(f));

      state.pending = streamFronts.length + jsonFronts.length;

      // SSE VISIEMS
      streamFronts.forEach(f=>{
        const back = FRONT_TO_BACK[f]||f;
        runSSE({ front:f, back, text, chatId:state.chatId })
          .catch(()=>{})
          .finally(()=>decPending());
      });

      // JSON GRUPEI ‚Äì po soft timeout
      if (jsonFronts.length){
        setTimeout(()=>{
          runJSONOnce({ fronts: jsonFronts, text, chatId: state.chatId })
            .catch(()=>{}); // decPending viduje
        }, 1000);
      }

      // Kietas deadline, jei kas pakibo
      setTimeout(()=>{ if (state.pending>0) finalizeRound(); }, 20000);
    }

    function decPending(){
      state.pending = Math.max(0, state.pending-1);
      if (state.pending===0) finalizeRound();
    }

    function finalizeRound(){
      hideGlobalWait();
      // klaidos ‚Äì apaƒçioje
      if (state.errors.length){
        const wrap = document.createElement('div');
        state.errors.forEach(er=>{
          const n = document.createElement('div'); n.className='message';
          n.innerHTML = `<div class="avatar"><img class="ui-icon" src="/assets/icon/ai.svg" alt=""></div>
            <div class="bubble"><div class="bubble-card error-card">
              <div class="msg-content"><strong>${escapeHtml(er.name||er.front||'Modelis')}</strong> ‚Äì atsakymo nepavyko gauti.<br><span class="dim">${escapeHtml(er.msg||'Klaida')}</span></div>
              <div class="msg-meta"><span>${escapeHtml(er.name||er.front||'Modelis')}</span><span>${timeNow()}</span></div>
            </div></div>`;
          wrap.appendChild(n);
        });
        chatArea.appendChild(wrap);
        autoscrollIfNeeded();
      }
      // follow-ups ‚Äì tik kai VISI baigƒó
      if (!state.suggestShown){
        state.suggestShown=true;
        showFollowUps();
      }
    }

    function parseErrEvent(e){
      try{
        const data = (e&&e.data)? JSON.parse(e.data):{};
        return data?.message || 'Klaida';
      }catch(_){ return 'Klaida'; }
    }

    // SSE runner
    function runSSE({ front, back, text, chatId }){
      return new Promise(async (resolve) => {
        try{
          const qs=new URLSearchParams({ model: back, models: back, message:text, max_tokens:'4096', chat_id:chatId, _t:Date.now().toString() });
          const resp=await fetch(`${SSE_URL}?${qs}`, { headers:{ 'Accept':'text/event-stream' }});
          const ct=(resp.headers.get('content-type')||'').toLowerCase();

          if(!ct.includes('text/event-stream')){
            // serveris grƒÖ≈æino JSON ‚Äì pabandom jƒØ
            try{
              const j=await resp.json();
              const txt=j?.answers?.[0]?.text||j?.text||'';
              if (txt){
                if (!state.hasAnyText){ state.hasAnyText=true; hideGlobalWait(); state.firstStarted=state.firstStarted||front; }
                const p = ensurePanel(front);
                p.content += txt;
                p.el.innerHTML = parseMarkdown(p.content);
                autoscrollIfNeeded();
              } else {
                state.errors.push({front, name:front, msg:'Tu≈°ƒçias atsakymas (JSON).'});
              }
            }catch(err){
              state.errors.push({front, name:front, msg:'Neskaidomas atsakymas (JSON).'});
            }
            return resolve();
          }

          const reader=resp.body.getReader();
          const dec=new TextDecoder();
          let buf='', gotAny=false;

          for(;;){
            const {done,value}=await reader.read(); if(done) break;
            buf+=dec.decode(value,{stream:true});
            let i; while((i=buf.indexOf('\n\n'))>=0){
              const frame=buf.slice(0,i).trim(); buf=buf.slice(i+2);
              if(!frame) continue;
              const dataLine = frame.split('\n').find(l=> l.startsWith('data:'));
              const eventLine = frame.split('\n').find(l=> l.startsWith('event:'));
              const ev = eventLine ? eventLine.replace(/^event:\s*/,'').trim() : 'message';
              if(!dataLine) continue;
              const data = dataLine.replace(/^data:\s*/,'').trim();
              if (data==='[DONE]'){ buf=''; break; }

              if (ev==='error'){
                if (!gotAny) state.errors.push({front, name:front, msg: parseErrEvent({data})});
                continue;
              }

              let piece='';
              try{
                const j=JSON.parse(data);
                piece = j?.choices?.[0]?.delta?.content ?? j?.text ?? j?.data ?? '';
              }catch{ piece = data; }

              if(piece){
                if (!state.hasAnyText){ state.hasAnyText=true; hideGlobalWait(); state.firstStarted=state.firstStarted||front; }
                gotAny=true;
                const p = ensurePanel(front);
                p.content += piece;
                p.el.innerHTML = parseMarkdown(p.content);
                autoscrollIfNeeded();
              }
            }
          }
          const p = state.panels[front]; if (p) p.done=true;
        }catch(e){
          state.errors.push({front, name:front, msg:'SSE nepavyko inicijuoti.'});
        }finally{
          resolve();
        }
      });
    }

    // JSON once runner (vienu ≈°≈´viu keliems NON_SSE)
    async function runJSONOnce({ fronts, text, chatId }){
      const backIds = fronts.map(f=> FRONT_TO_BACK[f]||f).join(',');
      try{
        const res = await fetch(COMPLETE_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message:text, models:backIds, chat_id:chatId, max_tokens:4096 })});
        if (!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        const answers = Array.isArray(j?.answers)? j.answers : [];
        const gotFronts = new Set();
        for (const ans of answers){
          const back = ans.model||'';
          const front = fronts.find(f=> (FRONT_TO_BACK[f]||f)===back) || fronts[0];
          gotFronts.add(front);
          const txt = ans.text||'';
          if (txt){
            if (!state.hasAnyText){ state.hasAnyText=true; hideGlobalWait(); state.firstStarted=state.firstStarted||front; }
            const p = ensurePanel(front);
            p.content += txt;
            p.el.innerHTML = parseMarkdown(p.content);
            autoscrollIfNeeded();
          } else {
            state.errors.push({ front, name:front, msg:'Tu≈°ƒçias atsakymas (JSON fallback).' });
          }
        }
        fronts.forEach(f=>{ if(!gotFronts.has(f)) state.errors.push({ front:f, name:f, msg:'Nepavyko gauti atsakymo (JSON fallback).' }); });
      }catch(e){
        fronts.forEach(f=> state.errors.push({ front:f, name:f, msg:'Nepavyko gauti atsakymo (JSON).' }) );
      }finally{
        // ma≈æinam pending kiekvienam json frontui
        fronts.forEach(()=>decPending());
      }
    }

    // ===== Follow-ups + AI re≈æimai (apaƒçioje) ‚Äì tik kai visi baigƒó
    function decisionChip(mode, label){
      const b=document.createElement('div'); b.className='decision-chip'; b.dataset.mode=mode; b.textContent=' '+label;
      const ico=document.createElement('img'); ico.className='ui-icon'; ico.src='/assets/icon/ai.svg'; ico.alt=''; b.prepend(ico);
      b.addEventListener('click', ()=>{
        msgInput.value = promptFor(mode);
        msgInput.focus();
        msgInput.dispatchEvent(new Event('input',{bubbles:true}));
      });
      return b;
    }
    function promptFor(mode){
      switch(mode){
        case 'debate': return 'Surengk AI ginƒçƒÖ: argumentai U≈Ω ir PRIE≈†, pabaigoje santrauka ir rekomendacija.';
        case 'judge': return 'Tu esi Teisƒójas. ƒÆvertink pateiktus argumentus, nurodyk, kas teisus ir kodƒól, remkis faktais.';
        case 'compromise': return 'Rask kompromisƒÖ tarp dviej≈≥ pozicij≈≥: ≈æingsniai, rizikos, sƒókmƒós kriterijai.';
        default: return '';
      }
    }
    async function showFollowUps(){
      const bestFront = state.firstStarted || Object.keys(state.panels)[0] || 'auto';
      const bestText  = (state.panels[bestFront]?.content || '').slice(0, 4000);
      const payload   = { message:(window.__LAST_USER_MSG__||''), answer: stripMd(bestText), count: 6 };
      followBar.innerHTML='';
      followBar.appendChild( decisionChip('debate','AI ginƒças') );
      followBar.appendChild( decisionChip('judge','Teisƒójas') );
      followBar.appendChild( decisionChip('compromise','Kompromisas') );

      try{
        const r=await fetch(SUGGEST_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const j= r.ok ? await r.json() : null;
        const list = Array.isArray(j?.suggestions) && j.suggestions.length ? j.suggestions :
          ['Paai≈°kink detaliau','Duok pavyzdƒØ','Sukurk veiksm≈≥ planƒÖ','Kokie pavojai?','Kokie KPI?','Alternatyvus sprendimas'];
        uniqueNonEmpty(list).slice(0,6).forEach(t=>{
          const b=document.createElement('div'); b.className='suggest-chip'; b.textContent=t; b.title=t; b.tabIndex=0;
          b.onclick=()=>{ msgInput.value=t; msgInput.focus(); };
          b.onkeydown=(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); b.click(); } };
          followBar.appendChild(b);
        });
      }catch(_){
        ['Paai≈°kink detaliau','Duok pavyzdƒØ','Sukurk veiksm≈≥ planƒÖ','Kokie pavojai?','Kokie KPI?','Alternatyvus sprendimas']
          .forEach(t=>{ const b=document.createElement('div'); b.className='suggest-chip'; b.textContent=t; b.onclick=()=>{ msgInput.value=t; msgInput.focus(); }; followBar.appendChild(b); });
      }
      followBar.classList.add('show');
    }

    // ===== Pagrindinis siuntimas
    async function doSend(){
      const text=(msgInput.value||'').trim(); if(!text) return;
      window.__LAST_USER_MSG__ = text;
      msgInput.value=''; inputDeck.classList.remove('show'); followBar.classList.remove('show'); followBar.innerHTML='';
      appendUserBubble(text);

      // aktyv≈´s front'ai
      let fronts=[...modelList.querySelectorAll('.model-pill.active')].map(b=>b.dataset.model);
      if(!fronts.length) fronts=['auto'];
      if(fronts.length===1 && fronts[0]==='auto'){ fronts=['chatgpt','deepseek','llama']; } // ‚Äûauto‚Äú ‚Äì sensownas trio

      // startuojam orkestra
      resetRound();
      startOrchestrator(text, fronts);
    }

    // ===== Inline deck (ƒØvesties pasi≈´lymai ‚Äì neauto-siuntimas)
    const STOCK = ['Paai≈°kink detaliau','Duok pavyzdƒØ','Sutrumpink iki 3 sakini≈≥','Sukurk veiksm≈≥ planƒÖ','Kokie KPI?'];
    function renderInline(list){
      inputDeck.innerHTML=''; (list||[]).slice(0,5).forEach(t=>{
        const b=document.createElement('div'); b.className='suggest-chip'; b.textContent=t; b.title=t; b.tabIndex=0;
        b.addEventListener('click', ()=>{ msgInput.value=t; msgInput.focus(); inputDeck.classList.remove('show'); });
        b.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); msgInput.value=t; msgInput.focus(); inputDeck.classList.remove('show'); }});
        inputDeck.appendChild(b);
      });
      if ((list||[]).length) inputDeck.classList.add('show'); else inputDeck.classList.remove('show');
    }

    // ƒÆvykiai
    msgInput.addEventListener('focus', ()=>{ if(!msgInput.value.trim()) renderInline(STOCK); });
    msgInput.addEventListener('input', ()=>{ if(msgInput.value.length===0) renderInline(STOCK); else inputDeck.classList.remove('show'); });
    msgInput.addEventListener('keyup', ()=>{ if(!msgInput.value.trim()) renderInline(STOCK); });
    sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); doSend(); });
    msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }});

    // Kad veikt≈≥ window.sendMessage()
    window.PauleMain = { sendMessage: doSend };
  })();
  </script>
</body>
</html>
