<!DOCTYPE html>
<html lang="lt" data-theme="light" data-backend="vercel">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Paule â€“ Premium AI Chat</title>

  <!-- Favicons -->
  <link rel="icon" href="/assets/icon/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/assets/icon/favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/icon/favicon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/assets/icon/apple-touch-icon.png">
  <meta name="theme-color" content="#111827"/>

  <!-- Pagrindinis CSS -->
  <link rel="stylesheet" href="/assets/css/paule.css?v=1.0.0">

  <!-- ===== PATCH: iÅ¡dÄ—stymas, mobilus, chips apaÄioje ===== -->
  <style>
  :root { --logo-w: 3cm; --topbar-h: 66px; }
  .topbar .brand { min-width: var(--logo-w); }
  .topbar .brand-icon{ width:var(--logo-w)!important; height:auto!important; object-fit:contain; display:block!important; }
  .topbar img, .topbar svg{ max-height: calc(var(--topbar-h) - 16px); }
  :root{ --ui-icon-filter:none }
  [data-theme="dark"] .ui-icon{ filter: invert(1) brightness(1.08) contrast(1.05); }
  [data-theme="dark"] img:not(.ui-icon){ filter:none !important; }

  .models-in-topbar{ gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .topbar{ position:sticky; top:0; left:0; right:0; z-index:1000; }
  #chatArea{ padding-top: calc(3cm + 6px) !important; z-index:1; }
  @media (max-height: 750px){ #chatArea{ padding-top: 24px !important; } }

  .message.user{ flex-direction:row-reverse; }
  .message.user .bubble{ margin-left:auto; }
  .bottom-section{ z-index:1100; padding-bottom:max(10px, env(safe-area-inset-bottom)); }

  @media (max-width: 768px){
    .topbar{
      grid-template-areas: "brand actions" "models models";
      grid-template-columns:auto 1fr; height:auto; padding-bottom:10px; row-gap:8px;
    }
    .brand{ grid-area:brand }
    .models-in-topbar{ grid-area:models; display:flex!important; max-width:100%; }
    .top-actions{ grid-area:actions; justify-content:flex-end }
    .top-actions [data-nav="community"], .theme-anchor{ display:none!important; }
  }
  @media (max-width:1024px){
    .layout{ grid-template-columns:0 1fr !important; }
    .sidebar{
      display:block!important; position:fixed; top:var(--topbar-h); left:-320px;
      width:300px; height:calc(100vh - var(--topbar-h));
      background:var(--bg-primary); border-right:1px solid var(--border);
      box-shadow:0 18px 60px rgba(0,0,0,.14); z-index:1350;
      transition:left .25s ease; overflow:auto;
    }
    .sidebar.open{ left:0; }
    .drawer-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      opacity:0; visibility:hidden; pointer-events:none; transition:.2s; z-index:1200;
    }
    .drawer-overlay.show{ opacity:1; visibility:visible; pointer-events:auto; }
    .mobile-only{ display:block!important; }
    .bottom-section{ left:var(--gutter)!important; right:var(--gutter)!important; }
  }

  /* ===== Chips (follow + decision) apaÄioje ir centruotos ===== */
  .follow-suggest-bar{
    display:none; gap:8px; flex-wrap:wrap; justify-content:center;
    margin:8px 0 6px 0; padding:8px 0 2px;
    overflow-x:auto; -webkit-overflow-scrolling:touch;
  }
  .follow-suggest-bar.show{ display:flex; }
  .suggest-chip, .decision-chip{
    display:inline-flex; align-items:center; white-space:nowrap;
    padding:6px 10px; border:1px solid var(--border); border-radius:12px;
    font-size:13px; line-height:1;
    background:var(--bg-secondary,rgba(0,0,0,0.03));
    cursor:pointer; user-select:none; transition:background .15s, border-color .15s, transform .05s;
  }
  .suggest-chip:hover, .decision-chip:hover{ background:rgba(0,0,0,.05); }
  .suggest-chip:active, .decision-chip:active{ transform:scale(.98); }

  /* spalvoti apvadai â€AI ginÄas / TeisÄ—jas / Kompromisasâ€œ */
  .decision-chip[data-mode="debate"]{ border-color:#7c3aed; }
  .decision-chip[data-mode="judge"]{  border-color:#16a34a; }
  .decision-chip[data-mode="compromise"]{ border-color:#2563eb; }

  /* Inline deck â€“ Ä¯ paÄiÄ… Ä¯vestÄ¯ */
  .input-container{ position:relative; }
  .input-suggest-deck{
    position:absolute; left:8px; right:56px; bottom:8px;
    display:none; align-items:center; gap:6px; padding:6px;
    border:1px solid var(--border); border-radius:10px;
    background:var(--bg-primary); box-shadow:0 6px 18px rgba(0,0,0,.06);
    overflow-x:auto; -webkit-overflow-scrolling:touch; z-index:5;
  }
  .input-suggest-deck.show{ display:flex; }
  .input-suggest-deck .suggest-chip{ font-size:12px; padding:6px 9px; }

  /* daugiau vietos Å¾inutei, kad kortelÄ—s neuÅ¾dengtÅ³ */
  .message-input{ padding-bottom:44px !important; }
  @media (max-width:480px){
    .input-suggest-deck{ left:6px; right:52px; bottom:6px; }
    .message-input{ padding-bottom:48px !important; }
  }

  /* ===== Svarbu: jokiÅ³ :has() â€“ valdome klase ===== */
  .bubble.hidden{ display:none !important; }
  </style>

  <!-- ğŸ”§ KonfigÅ«racija -->
  <script>
    (function () {
      var MODE=(document.documentElement.getAttribute('data-backend')||'').trim().toLowerCase()==='vercel'?'vercel':'wp';
      var restBase=MODE==='vercel'?'/api':'/wp-json/paule/v1';
      var routes={
        base:restBase, stream:restBase+'/stream', models:restBase+'/models', diagnostics:restBase+'/diagnostics',
        comicCreate:restBase+'/comic/create', fluxCreate:restBase+'/flux/create',
        musicCreate:restBase+'/music/create', musicStatus:restBase+'/music/status',
        runwayImage:restBase+'/runway/image', runwayStatus:restBase+'/runway/status'
      };
      var CFG={mode:MODE,restBase:routes.base,restStream:routes.stream,restStreamSSE:routes.stream,sseDefault:1,
        pluginBase:'/assets',iconsBase:'/assets/icon',featuresBase:'/assets/features',routes:routes,version:'paule-1.0.5'};
      window.PAULE_CONFIG=CFG; window.AUGAM_CONFIG=CFG;
      try{Object.defineProperty(window,'API_BASE',{configurable:true,get:function(){return CFG.restBase;},set:function(_){}});}catch(e){}
      window.__SET_API_BASE__=function(v){};
    })();
  </script>

  <!-- âœ… Bridge WP->/api -->
  <script>
    (function(){
      'use strict';
      try{
        var restBase=(window.PAULE_CONFIG&&window.PAULE_CONFIG.restBase)||'/api';
        if(window.EventSource){
          var OrigES=window.EventSource;
          window.EventSource=function(url,opts){
            try{url=String(url).replace(/\/wp-json\/(?:augam|paule)\/v1(\/|$)/,'/api$1').replace(/\/(?:augam|paule)\/v1(\/|$)/,'/api$1');}catch(_){}
            return new OrigES(url,opts);
          };
          window.EventSource.prototype=OrigES.prototype;
        }
        if(window.fetch){
          var origFetch=window.fetch;
          window.fetch=function(input,init){
            try{var u=(typeof input==='string')?input:(input&&input.url);
              if(u){var nu=String(u).replace(/\/wp-json\/(?:augam|paule)\/v1(\/|$)/,'/api$1').replace(/\/(?:augam|paule)\/v1(\/|$)/,'/api$1');
                if(nu!==u) input=(typeof input==='string')?nu:new Request(nu,input);
              }}catch(_){}
            return origFetch(input,init);
          };
        }
        window.__FORCE_STREAM_ENDPOINT__=restBase.replace(/\/+$/,'')+'/stream';
      }catch(e){console.warn('[PAULE bridge] warning:',e);}
    })();
  </script>

  <!-- ğŸ©¹ HOTFIX: jei POST /api/stream?mode=once grÄ¯Å¾ta SSE, paverÄiam Ä¯ JSON -->
  <script>
    (function(){
      'use strict';
      if (!window.fetch) return;
      const prevFetch = window.fetch;

      async function toJsonFromSSE(resp, models){
        const reader  = resp.body?.getReader?.();
        if (!reader) return null;
        const dec = new TextDecoder();
        let buf = '', text = '';
        for(;;){
          const it = await reader.read();
          if (it.done) break;
          buf += dec.decode(it.value, {stream:true});
          let idx;
          while ((idx = buf.indexOf('\n\n')) >= 0){
            const frame = buf.slice(0, idx).trim(); buf = buf.slice(idx+2);
            if (!frame) continue;
            const dataLine = frame.split('\n').find(l => l.startsWith('data:'));
            if (!dataLine) continue;
            const payload = dataLine.replace(/^data:\s*/,'').trim();
            if (payload === '[DONE]') { buf=''; break; }
            try{
              const j = JSON.parse(payload);
              const piece = j?.choices?.[0]?.delta?.content ?? j?.text ?? '';
              if (typeof piece === 'string') text += piece;
            }catch(_){}
          }
        }
        const answers = (models && models.length ? models : ['auto']).map(m => ({ model:m, text }));
        return { ok:true, answers };
      }

      window.fetch = async function(input, init){
        const url  = typeof input==='string' ? input : (input && input.url) || '';
        const meth = (init && init.method) || (typeof input!=='string' && input && input.method) || 'GET';
        const isStreamOnce = /\/api\/stream(?:\?|$)/.test(url) && /mode=once/.test(url) && String(meth).toUpperCase()==='POST';
        if (!isStreamOnce) return prevFetch(input, init);

        let models = [];
        try {
          const raw = (init && init.body) ? String(init.body) : '';
          if (raw) {
            const b = JSON.parse(raw);
            if (typeof b.models === 'string') { models = b.models.split(',').map(s=>s.trim()).filter(Boolean); }
          }
        } catch(_){}

        const resp = await prevFetch(input, init);
        const ct   = (resp.headers.get('content-type')||'').toLowerCase();
        if (ct.includes('text/event-stream')) {
          const json = await toJsonFromSSE(resp, models);
          if (json) {
            return new Response(JSON.stringify(json), {
              status: 200,
              headers: { 'Content-Type':'application/json; charset=utf-8', 'Cache-Control':'no-store' }
            });
          }
        }
        return resp;
      };
    })();
  </script>

  <!-- Globalus alias -->
  <script>
    window.sendMessage = function(){
      if (window.PauleMain && typeof window.PauleMain.sendMessage === 'function'){
        return window.PauleMain.sendMessage();
      }
    };
  </script>
</head>
<body>

  <!-- ===== TOPBAR ===== -->
  <header class="topbar" data-no-clip="true" id="topbar">
    <a class="brand" href="/" aria-label="Paule">
      <img id="brandLogo" class="brand-icon" src="/assets/icon/paule-logo.webp" alt="paule">
    </a>

    <nav class="models-in-topbar" aria-label="Modeliai" id="modelList">
      <button class="model-pill active" data-model="auto" aria-pressed="true"><img class="ui-icon" src="/assets/icon/paule-icon.webp" alt=""> Paule</button>
      <button class="model-pill" data-model="chatgpt"><img class="ui-icon" src="/assets/icon/chatgpt.svg" alt=""> ChatGPT</button>
      <button class="model-pill" data-model="claude"><img class="ui-icon" src="/assets/icon/claude-seeklogo.svg" alt=""> Claude</button>
      <button class="model-pill" data-model="gemini"><img class="ui-icon" src="/assets/icon/gemini.svg" alt=""> Gemini</button>
      <button class="model-pill" data-model="grok"><img class="ui-icon" src="/assets/icon/xAI.svg" alt=""> Grok</button>
      <button class="model-pill" data-model="deepseek"><img class="ui-icon" src="/assets/icon/deepseek.svg" alt=""> DeepSeek</button>
      <button class="model-pill" data-model="llama"><img class="ui-icon" src="/assets/icon/llama.svg" alt=""> Llama</button>
    </nav>

    <div class="top-actions" id="topActions">
      <a class="btn ghost" data-nav="community" href="/community" role="button">
        <img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> BendruomenÄ—
      </a>
      <button class="btn ghost" id="btnNewChat">
        <img class="ui-icon" src="/assets/icon/nav-new-chat.svg" alt=""> Naujas pokalbis
      </button>

      <div class="login-anchor theme-anchor">
        <button class="btn ghost" id="btnTheme"><img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> Tema</button>
        <div class="login-dropdown" id="themeDropdown">
          <button class="btn" data-theme="light">Å viesi</button>
          <button class="btn" data-theme="dark">Tamsi</button>
        </div>
      </div>

      <div class="login-anchor" id="loginAnchor">
        <button class="btn ghost" id="btnLogin">
          <img class="ui-icon" src="/assets/icon/user.svg" alt=""> Prisijungti
        </button>
        <div class="login-dropdown" id="loginDropdown">
          <a class="btn" id="googleLoginBtn" href="#"><img class="ui-icon" src="/assets/icon/google.svg" alt=""> Prisijungti su Google</a>
          <a class="btn" id="emailLoginBtn"  href="#"><img class="ui-icon" src="/assets/icon/mail.svg"   alt=""> Prisijungti el. paÅ¡tu</a>
        </div>
      </div>

      <button class="btn ghost mobile-toggle" id="btnMobile" aria-label="Meniu (mobilus)">
        <img class="ui-icon" src="/assets/icon/nav-menu.svg" alt=""> Meniu
      </button>
    </div>
  </header>

  <div id="drawerOverlay" class="drawer-overlay"></div>

  <div class="layout" id="layoutRoot">
    <aside class="sidebar" id="sidebar">
      <section class="side-section mobile-only" style="display:none" id="mobileQuick">
        <a class="project-item" href="/community"><img class="ui-icon" src="/assets/icon/nav-results.svg" alt=""> BendruomenÄ—</a>
        <div class="control-group" style="display:flex;gap:8px;margin-top:8px">
          <button class="chip" data-set-theme="light"><img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> Å viesi</button>
          <button class="chip" data-set-theme="dark"><img class="ui-icon" src="/assets/icon/nav-theme.svg" alt=""> Tamsi</button>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">AI specialistai</div>
        <div class="specialist-grid" id="specialistGrid">
          <a class="chip" href="#spec-sefas" data-route="/spec/sefas" data-spec="sefas"><img class="ui-icon" src="/assets/icon/chef-knife.svg" alt=""> Å efas</a>
          <a class="chip" href="#spec-marketing" data-route="/spec/marketing" data-spec="marketing"><img class="ui-icon" src="/assets/icon/marketing-megaphone.svg" alt=""> Marketing</a>
          <a class="chip" href="#spec-pardavimai" data-route="/spec/pardavimai" data-spec="pardavimai"><img class="ui-icon" src="/assets/icon/sales-handshake.svg" alt=""> Pardavimai</a>
          <a class="chip" href="#spec-verslas" data-route="/spec/verslas" data-spec="verslas"><img class="ui-icon" src="/assets/icon/business-strategy.svg" alt=""> Verslas</a>
          <a class="chip" href="#spec-finansai" data-route="/spec/finansai" data-spec="finansai"><img class="ui-icon" src="/assets/icon/finance-investment.svg" alt=""> Finansai</a>
          <a class="chip" href="#spec-keliones" data-route="/spec/keliones" data-spec="keliones"><img class="ui-icon" src="/assets/icon/travel-map.svg" alt=""> KelionÄ—s</a>
          <a class="chip" href="#spec-renginiai" data-route="/spec/renginiai" data-spec="renginiai"><img class="ui-icon" src="/assets/icon/event-planning.svg" alt=""> Renginiai</a>
          <a class="chip" href="/spec/goal.html" data-route="/spec/goal.html" data-spec="goal"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> TikslÅ³ Å¾emÄ—lapis</a>
          <a class="chip" href="#spec-teise" data-route="/spec/teisininkas" data-spec="teisininkas"><img class="ui-icon" src="/assets/icon/legal-contract.svg" alt=""> Teisininkas</a>
          <a class="chip" href="#spec-psichologas" data-route="/spec/psichologas" data-spec="psichologas"><img class="ui-icon" src="/assets/icon/psychology-brain.svg" alt=""> Psichologas</a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Aktyvumas</div>
        <div class="community-pings" id="communityPings">
          <div class="ping"><img class="ui-icon" src="/assets/icon/music.svg" alt=""> @Mantas Ä¯kÄ—lÄ— dainÄ… â€Vasaros vÄ—jasâ€œ</div>
          <div class="ping"><img class="ui-icon" src="/assets/icon/photo.svg" alt=""> @Ieva pridÄ—jo 3 nuotraukas</div>
          <div class="ping"><img class="ui-icon" src="/assets/icon/video-library.svg" alt=""> @Ruta publikavo â€Reklama-15sâ€œ</div>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#dainos">Dainos</a></div>
        <div class="library-grid thumbs" id="songsFeed">
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>â€Vasaros vÄ—jasâ€œ</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>â€Nakties Å¡viesosâ€œ</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/music.webp" alt=""><span>â€Miesto pulsasâ€œ</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#nuotraukos">Nuotraukos</a></div>
        <div class="library-grid thumbs" id="photosFeed">
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Produktas</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>Kampanija</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/photo.webp" alt=""><span>VirÅ¡elis</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title"><a class="lib-link" href="/biblioteka#video">Video</a></div>
        <div class="library-grid thumbs" id="videosFeed">
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Reklama 15s</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>Pristatymas</span></a>
          <a class="lib-card thumb"><img src="/assets/hero/video.webp" alt=""><span>UÅ¾kulisiai</span></a>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">Projektai</div>
        <div class="control-group" id="projectsList">
          <div class="project-item" data-project="new">
            <img class="ui-icon" src="/assets/icon/plus.svg" alt=""> Naujas projektas
          </div>
        </div>
      </section>

      <section class="side-section">
        <div class="side-title">PokalbiÅ³ istorija</div>
        <div class="control-group" id="historyList"></div>
      </section>
    </aside>

    <main class="main">
      <div class="chat-area" id="chatArea">
        <section class="welcome" id="welcome">
          <h1 class="hero-title">KAIP GALIU PADÄ–TI Å IANDIEN?</h1>
          <p>Pasirinkite AI specialistÄ… kairÄ—je arba pradÄ—kite pokalbÄ¯ Å¾emiau. VirÅ¡uje galite rinktis vienÄ… ar kelis modelius. ğŸ‘‡</p>

          <div class="welcome-grid">
            <a class="welcome-card" href="#" data-action="song">
              <img src="/assets/hero/music.webp" alt="">
              <b>Sukurti dainÄ…</b><span>Pasveikink draugÄ… unikalia gimtadienio daina.</span>
            </a>
            <a class="welcome-card" href="#" data-action="song-photo">
              <img src="/assets/hero/song-photo.webp" alt="">
              <b>Daina iÅ¡ nuotraukos</b><span>Ä®kelk kadrÄ… ir gauk originaliÄ… melodijÄ… su Å¾odÅ¾iais.</span>
            </a>
            <a class="welcome-card" href="#" data-action="photo">
              <img src="/assets/hero/photo.webp" alt="">
              <b>Sukurti nuotraukÄ…</b><span>Produktai, scenos, peizaÅ¾ai, selfiai ir animacija.</span>
            </a>
            <a class="welcome-card" href="#" data-action="mindmap">
              <img src="/assets/hero/mindmap.webp" alt="">
              <b>MinÄiÅ³ Å¾emÄ—lapis</b><span>Susitelk Ä¯ esmÄ™ ir didink produktyvumÄ….</span>
            </a>
            <a class="welcome-card" href="/spec/goal.html">
              <img src="/assets/hero/goals.webp" alt="">
              <b>TikslÅ³ sistema (AI)</b><span>Vizija â†’ uÅ¾duotys â†’ realÅ«s rezultatai.</span>
            </a>
            <a class="welcome-card" href="#" data-action="video">
              <img src="/assets/hero/video.webp" alt="">
              <b>Sukurti video</b><span>Reels ir Stories iÅ¡ teksto ar nuotraukÅ³.</span>
            </a>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- ===== BOTTOM INPUT ===== -->
  <div class="bottom-section after-message" id="bottomSection" data-responsive="true">
    <!-- â–¶ Follow-up + Decision (apaÄioje) -->
    <div class="follow-suggest-bar" id="followSuggestBar" aria-live="polite"></div>

    <div class="input-bar" id="inputBar">
      <div class="input-container" id="inputContainer">
        <textarea class="message-input" id="messageInput" rows="1" placeholder="Å½inutÄ— specialistuiâ€¦" autocomplete="on" autocapitalize="sentences" autocorrect="on" spellcheck="true"></textarea>
        <button class="send-btn" id="sendBtn" aria-label="SiÅ³sti">
          <img class="ui-icon" src="/assets/icon/arrow-top.svg" alt="">
        </button>
        <!-- â–¶ Inline kortelÄ—s Ä¯ paÄiÄ… Ä¯vestÄ¯ -->
        <div class="input-suggest-deck" id="inputSuggestDeck" aria-live="polite"></div>
      </div>
    </div>

    <div class="tools-bar" id="toolsBar">
      <div class="tool" data-tool="mindmap"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> Mindmap</div>
      <div class="tool" data-tool="photo"><img class="ui-icon" src="/assets/icon/tool-photo.svg" alt=""> Foto</div>
      <div class="tool" data-tool="file"><img class="ui-icon" src="/assets/icon/tool-file.svg" alt=""> Failas</div>
      <div class="tool" data-tool="song"><img class="ui-icon" src="/assets/icon/tool-music.svg" alt=""> Sukurti dainÄ…</div>
      <div class="tool" data-tool="video"><img class="ui-icon" src="/assets/icon/video-plus.svg" alt=""> Sukurti video</div>
      <div class="tool" data-tool="goals"><img class="ui-icon" src="/assets/icon/tool-mindmap.svg" alt=""> TikslÅ³ sistema</div>
    </div>
  </div>

  <!-- ===== Minimal JS: tema, modeliai, siuntimas, streaming ===== -->
  <script>
  (function(){
    const root=document.documentElement;
    const sidebar=document.getElementById('sidebar');
    const overlay=document.getElementById('drawerOverlay');
    const btnMobile=document.getElementById('btnMobile');
    const msgInput=document.getElementById('messageInput');
    const sendBtn=document.getElementById('sendBtn');
    const btnTheme=document.getElementById('btnTheme');
    const themeDropdown=document.getElementById('themeDropdown');
    const logo=document.getElementById('brandLogo');
    const modelList=document.getElementById('modelList');
    const chatArea  = document.getElementById('chatArea');
    const followBar = document.getElementById('followSuggestBar');
    const inputDeck = document.getElementById('inputSuggestDeck');
    const restBase  = (window.PAULE_CONFIG&&window.PAULE_CONFIG.restBase)||'/api';
    const streamBase= (window.PAULE_CONFIG&&window.PAULE_CONFIG.restStream)||'/api/stream';

    function setLogoByTheme(){
      const dark = root.getAttribute('data-theme') === 'dark';
      logo.src = dark ? '/assets/icon/paule-logo-dark.webp' : '/assets/icon/paule-logo.webp';
    }
    setLogoByTheme();
    new MutationObserver(setLogoByTheme).observe(root,{attributes:true,attributeFilter:['data-theme']});

    btnTheme?.addEventListener('click', (e)=>{ e.preventDefault(); themeDropdown?.classList.toggle('open'); });
    themeDropdown?.addEventListener('click', (e)=>{
      const b=e.target.closest('[data-theme]'); if(!b) return;
      root.setAttribute('data-theme', b.getAttribute('data-theme'));
      themeDropdown.classList.remove('open');
    });

    function openDrawer(){ sidebar.classList.add('open'); overlay.classList.add('show'); document.body.style.overflow='hidden'; }
    function closeDrawer(){ sidebar.classList.remove('open'); overlay.classList.remove('show'); document.body.style.overflow=''; }
    btnMobile?.addEventListener('click', openDrawer);
    overlay?.addEventListener('click', closeDrawer);

    // ===== ModeliÅ³ pasirinkimas
    const MODEL_MAP={
      auto:   'gpt-4o-mini',
      chatgpt:'gpt-4o-mini',
      claude: 'claude-3-5-sonnet',
      gemini: 'gemini-1.5-flash',
      grok:   'grok-2',
      deepseek:'deepseek-chat',
      llama:  'meta-llama/Llama-4-Scout-17B-16E-Instruct'
    };
    modelList.addEventListener('click', (e)=>{
      const b=e.target.closest('.model-pill'); if(!b) return;
      if(b.dataset.model==='auto'){
        // "Paule" â€“ paliekam vienÄ… aktyvÅ³
        modelList.querySelectorAll('.model-pill').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); b.setAttribute('aria-pressed','true');
      }else{
        b.classList.toggle('active');
        b.setAttribute('aria-pressed', b.classList.contains('active')?'true':'false');
        modelList.querySelector('.model-pill[data-model="auto"]')?.classList.remove('active');
      }
    });

    // ===== UI helperiai
    function chip(text, onClick){ const b=document.createElement('div'); b.className='suggest-chip'; b.textContent=text; b.title=text; b.tabIndex=0;
      b.addEventListener('click', onClick);
      b.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onClick();} });
      return b;
    }
    function decisionChip(mode, label){
      const b=document.createElement('div'); b.className='decision-chip'; b.dataset.mode=mode; b.textContent=' '+label;
      const ico=document.createElement('img'); ico.className='ui-icon'; ico.src='/assets/icon/ai.svg'; ico.alt=''; b.prepend(ico);
      b.addEventListener('click', ()=>{ insertToInput(promptFor(mode)); });
      return b;
    }
    function insertToInput(text){
      msgInput.value=text;
      msgInput.focus();
      msgInput.dispatchEvent(new Event('input',{bubbles:true}));
    }

    function renderFollowups(userMsg, aiMsg){
      // jei nieko nÄ—ra â€“ slÄ—pti juostÄ…
      if (!userMsg && !aiMsg){ followBar.classList.remove('show'); followBar.innerHTML=''; return; }

      const STOCK = ['PaaiÅ¡kink detaliau','Duok pavyzdÄ¯','Sutrumpink iki 3 sakiniÅ³','Sukurk veiksmÅ³ planÄ…','Kokie KPI?','Alternatyvus sprendimas'];
      followBar.innerHTML='';
      // 1) AI reÅ¾imai
      followBar.appendChild( decisionChip('debate','AI ginÄas') );
      followBar.appendChild( decisionChip('judge','TeisÄ—jas') );
      followBar.appendChild( decisionChip('compromise','Kompromisas') );
      // 2) pasiÅ«lymai iÅ¡ API (jei veikia), kitaip â€“ stock
      fetch(restBase+'/suggest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message:userMsg||'', answer:aiMsg||'', count:6 }) })
        .then(r=>r.ok?r.json():null)
        .then(j=>{
          const list=(j&&j.ok&&Array.isArray(j.suggestions)&&j.suggestions.length)?j.suggestions:STOCK;
          list.slice(0,6).forEach(t=> followBar.appendChild( chip(t, ()=>insertToInput(t)) ));
          followBar.classList.add('show');
        })
        .catch(()=>{
          STOCK.slice(0,6).forEach(t=> followBar.appendChild( chip(t, ()=>insertToInput(t)) ));
          followBar.classList.add('show');
        });
    }

    function promptFor(mode){
      switch(mode){
        case 'debate': return 'Surengk AI ginÄÄ…: argumentai UÅ½ ir PRIEÅ , pabaigoje santrauka ir rekomendacija.';
        case 'judge': return 'Tu esi TeisÄ—jas. Ä®vertink pateiktus argumentus, nurodyk, kas teisus ir kodÄ—l, remkis faktais.';
        case 'compromise': return 'Rask kompromisÄ… tarp dviejÅ³ pozicijÅ³: Å¾ingsniai, rizikos, sÄ—kmÄ—s kriterijai.';
        default: return '';
      }
    }

    // ===== Å½inuÄiÅ³ burbulai
    function appendUserBubble(text){
      document.getElementById('welcome')?.remove();
      const wrap=document.createElement('div'); wrap.className='message user';
      wrap.innerHTML = `
        <div class="avatar"><img class="ui-icon" src="/assets/icon/user.svg" alt=""></div>
        <div class="bubble" data-model="user">
          <div class="bubble-card">
            <div class="msg-content"></div>
            <div class="msg-meta"><span class="model-tag">JÅ«s</span><span>now</span></div>
          </div>
        </div>`;
      chatArea.appendChild(wrap);
      wrap.querySelector('.msg-content').textContent=text;
      chatArea.scrollTo({top: chatArea.scrollHeight, behavior:'smooth'});
      return wrap;
    }

    function createAIBubble(modelKey){
      const wrap=document.createElement('div'); wrap.className='message';
      const mdl=(modelKey||'').split('/').pop();
      wrap.innerHTML=`<div class="avatar"><img class="ui-icon" src="/assets/icon/ai.svg" alt=""></div>
        <div class="bubble hidden" data-model="${mdl}"><div class="bubble-card">
          <div class="msg-content"></div>
          <div class="msg-meta"><span class="model-tag">${mdl}</span><span>streamingâ€¦</span></div>
        </div></div>`;
      chatArea.appendChild(wrap);
      chatArea.scrollTo({top:chatArea.scrollHeight,behavior:'smooth'});
      return wrap;
    }

    // ===== SSE / JSON klientas
    async function streamOnce(model, text, outEl, chatId, bubbleEl){
      const q=new URLSearchParams({ model, models:model, message:text, max_tokens:'4096', chat_id:chatId, _t:Date.now().toString() });
      const resp=await fetch(`${streamBase}?${q}`, { headers:{ 'Accept':'text/event-stream' }});
      const ct=(resp.headers.get('content-type')||'').toLowerCase();

      let opened=false; const openNow=()=>{ if(!opened){ bubbleEl.classList.remove('hidden'); opened=true; } };

      // JSON fallback
      if(!ct.includes('text/event-stream')){
        try{
          const j=await resp.json();
          const txt=j?.answers?.[0]?.text||j?.text||'';
          if(txt){ openNow(); outEl.textContent += txt; }
        }catch(_){
          const txt=await resp.text();
          if(txt){ openNow(); outEl.textContent += txt; }
        }
        return;
      }

      // SSE
      const reader=resp.body.getReader();
      const dec=new TextDecoder();
      let buf='';
      for(;;){
        const {done,value}=await reader.read(); if(done) break;
        buf+=dec.decode(value,{stream:true});
        let i; while((i=buf.indexOf('\n\n'))>=0){
          const frame=buf.slice(0,i).trim(); buf=buf.slice(i+2);
          if(!frame) continue;
          const line=frame.split('\n').find(l=>l.startsWith('data:')); if(!line) continue;
          const data=line.slice(5).trim();
          if(data==='[DONE]'){ buf=''; break; }
          let piece='';
          try{
            const j=JSON.parse(data);
            piece = j?.choices?.[0]?.delta?.content ?? j?.text ?? j?.data ?? '';
          }catch{ piece = data; }
          if(piece){ openNow(); outEl.textContent += piece; }
        }
      }
    }

    // ===== Pagrindinis siuntimas
    async function doSend(){
      const text=(msgInput.value||'').trim(); if(!text) return;
      msgInput.value=''; inputDeck.classList.remove('show'); followBar.classList.remove('show'); followBar.innerHTML='';
      const userNode=appendUserBubble(text);

      // aktyvÅ«s modeliai
      let keys=[...modelList.querySelectorAll('.model-pill.active')].map(b=>b.dataset.model);
      if(!keys.length) keys=['auto'];
      // jei â€autoâ€œ â€“ vienas modelis (gpt-4o-mini)
      if(keys.length===1 && keys[0]==='auto') keys=['chatgpt'];

      const models=keys.map(k=>MODEL_MAP[k]).filter(Boolean);
      const chatId='chat_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);

      let lastAssistantText='';

      for(const k of keys){
        const bubble=createAIBubble(k);
        const out = bubble.querySelector('.msg-content');
        const bubbleEl = bubble.querySelector('.bubble');
        try{
          await streamOnce(MODEL_MAP[k], text, out, chatId, bubbleEl);
          lastAssistantText = out.textContent || lastAssistantText;
        }catch(err){
          bubbleEl.classList.remove('hidden');
          out.textContent = 'âš ï¸ Klaida gaunant atsakymÄ….';
          console.error(err);
        }
      }

      // follow-ups ir AI reÅ¾imai apaÄioje â€“ tik jei gavome bent kaÅ¾kÄ…
      if(lastAssistantText && lastAssistantText.trim()){
        renderFollowups(text, lastAssistantText);
      }
    }

    // ===== Inline deck (Ä¯vesties pasiÅ«lymai â€“ neauto-siuntimas)
    const STOCK = ['PaaiÅ¡kink detaliau','Duok pavyzdÄ¯','Sutrumpink iki 3 sakiniÅ³','Sukurk veiksmÅ³ planÄ…','Kokie KPI?'];
    function renderInline(list){
      inputDeck.innerHTML=''; (list||[]).slice(0,5).forEach(t=>{
        const b=document.createElement('div'); b.className='suggest-chip'; b.textContent=t; b.title=t; b.tabIndex=0;
        b.addEventListener('click', ()=>{ msgInput.value=t; msgInput.focus(); inputDeck.classList.remove('show'); });
        b.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); msgInput.value=t; msgInput.focus(); inputDeck.classList.remove('show'); }});
        inputDeck.appendChild(b);
      });
      if ((list||[]).length) inputDeck.classList.add('show'); else inputDeck.classList.remove('show');
    }

    // Ä®vykiai
    msgInput.addEventListener('focus', ()=>{ if(!msgInput.value.trim()) renderInline(STOCK); });
    msgInput.addEventListener('input', ()=>{ if(msgInput.value.length===0) renderInline(STOCK); else inputDeck.classList.remove('show'); });
    msgInput.addEventListener('keyup', ()=>{ if(!msgInput.value.trim()) renderInline(STOCK); });
    sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); doSend(); });
    msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }});

    // Kad veiktÅ³ window.sendMessage()
    window.PauleMain = { sendMessage: doSend };
  })();
  </script>

  <!-- (neprivaloma) iÅ¡oriniai skriptai, jei naudoji -->
  <!-- <script src="/assets/js/models.js?v=1.3.0" defer></script> -->
  <!-- <script src="/assets/js/paule-ui.js?v=1.2.1" defer></script> -->
</body>
</html>

